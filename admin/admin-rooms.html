<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room Configuration - Cherry Tree Centre</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f6fa;
      min-height: 100vh;
    }
    
    /* Header */
    .admin-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .header-left h1 {
      font-size: 20px;
      font-weight: 500;
    }
    
    .back-link {
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 14px;
    }
    
    .back-link:hover {
      color: white;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .location-filter {
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
      min-width: 150px;
    }
    
    .location-filter option {
      background: #1a1a2e;
      color: white;
    }
    
    .add-btn, .settings-btn {
      background: #007bff;
      border: none;
      color: white;
      padding: 12px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }
    
    .add-btn:hover, .settings-btn:hover {
      background: #0056b3;
    }
    
    .settings-btn {
      background: #6c757d;
    }
    
    .settings-btn:hover {
      background: #5a6268;
    }
    
    .save-btn {
      background: #28a745;
      border: none;
      color: white;
      padding: 12px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.2s;
    }
    
    .save-btn:hover {
      background: #218838;
    }
    
    .save-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    /* Main Content */
    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }
    
    /* Info Box */
    .info-box {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    .info-box h2 {
      color: #1a1a2e;
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .info-box p {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 5px;
    }
    
    /* Status Message */
    .status-message {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .status-message.show {
      display: block;
    }
    
    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-message.info {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    /* Location Section */
    .location-section {
      margin-bottom: 30px;
    }
    
    .location-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 12px 12px 0 0;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    
    .location-header.henley {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .location-header.buckhurst_hill {
      background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    }
    
    .location-header.oxford {
      background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
    }
    
    .location-prefix-badge {
      background: rgba(255, 255, 255, 0.25);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    /* Rooms Grid */
    .rooms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 0 0 12px 12px;
      border: 1px solid #e0e0e0;
      border-top: none;
    }
    
    .room-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .room-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
    }
    
    .room-card.disabled {
      opacity: 0.5;
    }
    
    .room-card-header {
      padding: 15px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
    }
    
    .room-name-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .room-name {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a2e;
    }
    
    .room-id-badge {
      background: #e9ecef;
      color: #495057;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .delete-btn {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-size: 18px;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .delete-btn:hover {
      background: #fee;
    }
    
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 26px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    input:checked + .toggle-slider {
      background-color: #28a745;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    .room-card-body {
      padding: 18px;
    }
    
    .color-group {
      margin-bottom: 15px;
    }
    
    .color-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .color-picker-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .color-picker {
      width: 50px;
      height: 36px;
      border: 2px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      padding: 0;
    }
    
    .color-picker::-webkit-color-swatch-wrapper {
      padding: 2px;
    }
    
    .color-picker::-webkit-color-swatch {
      border-radius: 3px;
      border: none;
    }
    
    .color-value {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #666;
      background: #f8f9fa;
      padding: 8px 10px;
      border-radius: 4px;
      flex: 1;
    }
    
    /* Henley Room ID (transition) */
    .henley-id-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed #ddd;
    }
    
    .henley-id-label {
      font-size: 11px;
      color: #999;
      text-transform: uppercase;
    }
    
    .henley-id-value {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #6c757d;
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    /* Preview */
    .room-preview {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      font-weight: 600;
      font-size: 13px;
      border: 3px solid;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #eee;
      border-top-color: #1a1a2e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s;
    }
    
    .modal-overlay.show .modal {
      transform: scale(1);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      font-size: 18px;
      font-weight: 500;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #007bff;
    }
    
    .form-group input:disabled {
      background: #e9ecef;
      color: #495057;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .modal-footer {
      padding: 20px 25px;
      background: #f8f9fa;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      border-top: 1px solid #eee;
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
    }
    
    /* Preview in modal */
    .preview-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
    }
    
    .preview-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .preview-box {
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      font-weight: 600;
      border: 3px solid;
    }
    
    .id-preview {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    
    .id-preview code {
      background: #e9ecef;
      padding: 4px 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-weight: 600;
      color: #495057;
    }
    
    /* Location Settings Table */
    .location-settings-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .location-settings-table th,
    .location-settings-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    .location-settings-table th {
      background: #f8f9fa;
      font-weight: 600;
      font-size: 13px;
      color: #666;
    }
    
    .location-settings-table input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 80px;
      text-transform: uppercase;
    }
    
    .location-settings-table .next-room {
      font-family: 'Courier New', monospace;
      color: #666;
    }
    
    .add-location-btn {
      margin-top: 15px;
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .add-location-btn:hover {
      background: #218838;
    }
    
    /* ================================ */
    /* MOBILE STYLES                    */
    /* ================================ */
    @media (max-width: 768px) {
      .admin-header {
        padding: 10px 12px;
        gap: 10px;
      }
      
      .header-left {
        gap: 10px;
        width: 100%;
      }
      
      .header-left h1 {
        font-size: 16px;
      }
      
      .back-link {
        font-size: 12px;
      }
      
      .header-controls {
        width: 100%;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .location-filter {
        flex: 1;
        min-width: 120px;
        padding: 8px 10px;
        font-size: 13px;
      }
      
      .add-btn, .save-btn, .settings-btn {
        flex: 1;
        padding: 10px 15px;
        font-size: 13px;
      }
      
      .main-content {
        padding: 10px;
      }
      
      .location-section {
        margin-bottom: 15px;
      }
      
      .location-header {
        padding: 10px 12px;
        font-size: 14px;
      }
      
      .rooms-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px;
      }
      
      .room-card-header {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .room-name-group {
        width: 100%;
        justify-content: space-between;
      }
      
      .modal {
        width: 95%;
        max-height: 95vh;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .header-controls {
        flex-direction: column;
      }
      
      .location-filter,
      .add-btn,
      .save-btn,
      .settings-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="header-left">
      <a href="admin-index.html" class="back-link">‚Üê Admin Portal</a>
      <h1>üö™ Room Configuration</h1>
    </div>
    <div class="header-controls">
      <select class="location-filter" id="locationFilter" onchange="filterByLocation()">
        <option value="all">All Locations</option>
      </select>
      <button class="settings-btn" onclick="openSettingsModal()">‚öôÔ∏è Location Settings</button>
      <button class="add-btn" onclick="openAddModal()">‚ûï Add Room</button>
      <button class="save-btn" id="saveBtn" onclick="saveSettings()">üíæ Save All Changes</button>
    </div>
  </header>
  
  <main class="main-content">
    <div class="info-box">
      <h2>‚ÑπÔ∏è Room Configuration</h2>
      <p><strong>Room ID:</strong> Each room has a unique ID (e.g., H1, BH2) shown next to its name. IDs are auto-generated based on location prefix.</p>
      <p><strong>Location Settings:</strong> Click "Location Settings" to configure prefixes for each building (H = Henley, BH = Buckhurst Hill, etc.)</p>
      <p><strong>Add Room:</strong> Click "Add Room" to create a new room. The ID will be auto-assigned based on the location.</p>
      <p><strong>Toggle Switch:</strong> Turn rooms on or off. Disabled rooms won't appear in booking calendars.</p>
      <p><strong>Save:</strong> Click "Save All Changes" to apply your settings to all calendars.</p>
    </div>
    
    <div class="status-message" id="statusMessage"></div>
    
    <div id="roomsContainer">
      <div class="loading">
        <div class="loading-spinner"></div>
        Loading room configuration...
      </div>
    </div>
  </main>
  
  <!-- Add Room Modal -->
  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <h2>‚ûï Add New Room</h2>
        <button class="modal-close" onclick="closeAddModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Room Name *</label>
          <input type="text" id="newRoomName" placeholder="e.g. Room 10, Meeting Room, etc." oninput="updateModalPreview()">
        </div>
        
        <div class="form-group">
          <label>Location *</label>
          <select id="newRoomLocation" onchange="updateModalPreview()">
            <!-- Populated dynamically -->
          </select>
        </div>
        
        <div class="form-group">
          <label>Room ID (auto-generated)</label>
          <input type="text" id="newRoomId" disabled>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Background Colour</label>
            <input type="color" id="newRoomColor" value="#90caf9" onchange="updateModalPreview()">
          </div>
          <div class="form-group">
            <label>Border Colour</label>
            <input type="color" id="newRoomBorder" value="#64b5f6" onchange="updateModalPreview()">
          </div>
        </div>
        
        <div class="form-group">
          <label>Display Order</label>
          <input type="number" id="newRoomOrder" value="10" min="1" max="99">
          <small style="color: #666; font-size: 12px;">Lower numbers appear first</small>
        </div>
        
        <div class="preview-section">
          <div class="preview-label">Preview</div>
          <div class="preview-box" id="modalPreview" style="background: #90caf9; border-color: #64b5f6; color: #333;">
            New Room
          </div>
          <div class="id-preview">
            Room ID: <code id="previewRoomId">--</code>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addRoom()">Add Room</button>
      </div>
    </div>
  </div>
  
  <!-- Location Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2>‚öôÔ∏è Location Settings</h2>
        <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
          Configure the ID prefix for each location. New rooms will be assigned IDs like "H1", "BH2", etc.
        </p>
        
        <table class="location-settings-table">
          <thead>
            <tr>
              <th>Location</th>
              <th>ID Prefix</th>
              <th>Next Room #</th>
            </tr>
          </thead>
          <tbody id="locationSettingsBody">
            <!-- Populated dynamically -->
          </tbody>
        </table>
        
        <button class="add-location-btn" onclick="openAddLocationModal()">‚ûï Add New Location</button>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveLocationSettings()">Save Settings</button>
      </div>
    </div>
  </div>
  
  <!-- Add Location Modal -->
  <div class="modal-overlay" id="addLocationModal">
    <div class="modal">
      <div class="modal-header">
        <h2>‚ûï Add New Location</h2>
        <button class="modal-close" onclick="closeAddLocationModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Location Key (no spaces) *</label>
          <input type="text" id="newLocationKey" placeholder="e.g. oxford, reading">
          <small style="color: #666; font-size: 12px;">Used internally - lowercase, no spaces</small>
        </div>
        
        <div class="form-group">
          <label>Display Name *</label>
          <input type="text" id="newLocationName" placeholder="e.g. Oxford, Reading">
        </div>
        
        <div class="form-group">
          <label>ID Prefix *</label>
          <input type="text" id="newLocationPrefix" placeholder="e.g. O, R" style="text-transform: uppercase;" maxlength="4">
          <small style="color: #666; font-size: 12px;">1-4 characters, used for room IDs</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddLocationModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addLocation()">Add Location</button>
      </div>
    </div>
  </div>
  
  <script>
    // ================================
    // CONFIGURATION
    // ================================
    const firebaseConfig = {
      apiKey: "AIzaSyCVp4QDAnh5RcxGZIrEY2LriUWKQNcNbzE",
      authDomain: "cherry-tree-bookings.firebaseapp.com",
      databaseURL: "https://cherry-tree-bookings-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cherry-tree-bookings",
      storageBucket: "cherry-tree-bookings.firebasestorage.app",
      messagingSenderId: "280166213685",
      appId: "1:280166213685:web:f80b11799f41f5f385297c"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Default location configuration
    const defaultLocationConfig = {
      'henley': {
        name: 'Henley',
        prefix: 'H',
        nextRoomNumber: 10,
        henleyLocationId: '2'
      },
      'buckhurst_hill': {
        name: 'Buckhurst Hill',
        prefix: 'BH',
        nextRoomNumber: 2,
        henleyLocationId: '1'
      }
    };
    
    // Default room configuration with IDs
    const defaultRoomConfig = {
      'Room_1': { id: 'H1', enabled: true, color: '#d4a5a5', borderColor: '#b89090', displayName: 'Room 1', location: 'henley', order: 1, henleyRoomId: '1' },
      'Room_2': { id: 'H2', enabled: true, color: '#b299d4', borderColor: '#9680c0', displayName: 'Room 2', location: 'henley', order: 2, henleyRoomId: '3' },
      'Room_4': { id: 'H4', enabled: true, color: '#a5d4a5', borderColor: '#90b890', displayName: 'Room 4', location: 'henley', order: 3, henleyRoomId: '10' },
      'Room_5': { id: 'H5', enabled: true, color: '#e57373', borderColor: '#d32f2f', displayName: 'Room 5', location: 'henley', order: 4, henleyRoomId: '20' },
      'Room_6': { id: 'H6', enabled: true, color: '#c8a882', borderColor: '#b5946e', displayName: 'Room 6', location: 'henley', order: 5, henleyRoomId: '4' },
      'Room_7': { id: 'H7', enabled: true, color: '#e6d45a', borderColor: '#d4c347', displayName: 'Room 7', location: 'henley', order: 6, henleyRoomId: '7' },
      'Car_Park': { id: 'H8', enabled: true, color: '#bdbdbd', borderColor: '#9e9e9e', displayName: 'Car Park', location: 'henley', order: 9, henleyRoomId: '12' },
      'Online': { id: 'BH1', enabled: true, color: '#7dd87d', borderColor: '#6bc46b', displayName: 'Online', location: 'buckhurst_hill', order: 1, henleyRoomId: '11' }
    };
    
    let locationConfig = {};
    let currentConfig = {};
    let currentFilter = 'all';
    let pendingLocationChanges = {};
    
    // ================================
    // INITIALIZATION
    // ================================
    document.addEventListener('DOMContentLoaded', () => {
      loadAllConfig();
    });
    
    // ================================
    // DATA LOADING
    // ================================
    async function loadAllConfig() {
      try {
        // Load location config first
        const locationSnap = await database.ref('location_config').once('value');
        const locData = locationSnap.val();
        
        if (locData && Object.keys(locData).length > 0) {
          locationConfig = locData;
          console.log('Loaded location config from Firebase');
        } else {
          locationConfig = JSON.parse(JSON.stringify(defaultLocationConfig));
          console.log('Using default location config');
        }
        
        // Now load room config
        const roomSnap = await database.ref('room_config').once('value');
        const roomData = roomSnap.val();
        
        if (roomData && Object.keys(roomData).length > 0) {
          currentConfig = {};
          
          // Start with defaults
          Object.keys(defaultRoomConfig).forEach(key => {
            currentConfig[key] = { ...defaultRoomConfig[key] };
          });
          
          // Override with Firebase values
          Object.keys(roomData).forEach(key => {
            if (currentConfig[key]) {
              currentConfig[key] = { ...currentConfig[key], ...roomData[key] };
            } else {
              currentConfig[key] = roomData[key];
            }
            
            // Ensure location field exists
            if (!currentConfig[key].location) {
              currentConfig[key].location = key === 'Online' ? 'buckhurst_hill' : 'henley';
            }
            
            // Generate ID if missing
            if (!currentConfig[key].id) {
              currentConfig[key].id = generateRoomId(currentConfig[key].location);
            }
          });
          
          console.log('Loaded room config from Firebase');
        } else {
          currentConfig = JSON.parse(JSON.stringify(defaultRoomConfig));
          console.log('Using default room config');
        }
        
        // Update UI
        populateLocationFilter();
        renderRoomsByLocation();
        
      } catch (error) {
        console.error('Error loading config:', error);
        showStatus('Error loading configuration - using defaults', 'error');
        locationConfig = JSON.parse(JSON.stringify(defaultLocationConfig));
        currentConfig = JSON.parse(JSON.stringify(defaultRoomConfig));
        populateLocationFilter();
        renderRoomsByLocation();
      }
    }
    
    // ================================
    // LOCATION FILTER
    // ================================
    function populateLocationFilter() {
      const select = document.getElementById('locationFilter');
      select.innerHTML = '<option value="all">All Locations</option>';
      
      Object.entries(locationConfig).forEach(([key, loc]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = loc.name;
        select.appendChild(option);
      });
    }
    
    function filterByLocation() {
      currentFilter = document.getElementById('locationFilter').value;
      renderRoomsByLocation();
    }
    
    // ================================
    // RENDERING
    // ================================
    function renderRoomsByLocation() {
      const container = document.getElementById('roomsContainer');
      container.innerHTML = '';
      
      // Group rooms by location
      const roomsByLocation = {};
      
      Object.entries(currentConfig).forEach(([roomKey, room]) => {
        const location = room.location || 'henley';
        if (!roomsByLocation[location]) {
          roomsByLocation[location] = [];
        }
        roomsByLocation[location].push({ key: roomKey, ...room });
      });
      
      // Get location order from locationConfig
      const locationOrder = Object.keys(locationConfig);
      
      // Add any locations that have rooms but aren't in config
      Object.keys(roomsByLocation).forEach(loc => {
        if (!locationOrder.includes(loc)) {
          locationOrder.push(loc);
        }
      });
      
      locationOrder.forEach(location => {
        if (!roomsByLocation[location]) return;
        if (currentFilter !== 'all' && currentFilter !== location) return;
        
        const rooms = roomsByLocation[location].sort((a, b) => (a.order || 99) - (b.order || 99));
        const locData = locationConfig[location] || { name: location, prefix: '?' };
        
        // Create location section
        const section = document.createElement('div');
        section.className = 'location-section';
        section.id = `location-${location}`;
        
        section.innerHTML = `
          <div class="location-header ${location}">
            <div>
              üìç ${locData.name}
              <span style="font-size: 14px; font-weight: normal; opacity: 0.9;">
                (${rooms.length} rooms)
              </span>
            </div>
            <span class="location-prefix-badge">Prefix: ${locData.prefix}</span>
          </div>
          <div class="rooms-grid" id="grid-${location}"></div>
        `;
        
        container.appendChild(section);
        
        // Add room cards
        const grid = document.getElementById(`grid-${location}`);
        rooms.forEach(room => {
          const card = createRoomCard(room.key, room, location);
          grid.appendChild(card);
        });
      });
      
      if (container.innerHTML === '') {
        container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No rooms found. Add a room to get started.</p>';
      }
    }
    
    function createRoomCard(roomKey, room, location) {
      const card = document.createElement('div');
      card.className = `room-card ${room.enabled ? '' : 'disabled'}`;
      card.id = `card-${roomKey}`;
      
      const henleyIdHtml = room.henleyRoomId ? `
        <div class="henley-id-row">
          <span class="henley-id-label">SBM Room ID:</span>
          <span class="henley-id-value">${room.henleyRoomId}</span>
        </div>
      ` : '';
      
      card.innerHTML = `
        <div class="room-card-header">
          <div class="room-name-group">
            <span class="room-name">${room.displayName}</span>
            <span class="room-id-badge">${room.id || '?'}</span>
          </div>
          <div class="header-actions">
            <button class="delete-btn" onclick="deleteRoom('${roomKey}')" title="Delete room">üóëÔ∏è</button>
            <label class="toggle-switch">
              <input type="checkbox" ${room.enabled ? 'checked' : ''} 
                     onchange="toggleRoom('${roomKey}')">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <div class="room-card-body">
          <div class="color-group">
            <label class="color-label">Background</label>
            <div class="color-picker-row">
              <input type="color" class="color-picker" value="${room.color}" 
                     onchange="updateColor('${roomKey}', 'color', this.value)">
              <span class="color-value" id="color-${roomKey}">${room.color}</span>
            </div>
          </div>
          
          <div class="color-group">
            <label class="color-label">Border</label>
            <div class="color-picker-row">
              <input type="color" class="color-picker" value="${room.borderColor}" 
                     onchange="updateColor('${roomKey}', 'borderColor', this.value)">
              <span class="color-value" id="border-${roomKey}">${room.borderColor}</span>
            </div>
          </div>
          
          <div class="room-preview" id="preview-${roomKey}" 
               style="background: ${room.color}; border-color: ${room.borderColor}; color: #333;">
            ${room.displayName}
          </div>
          
          ${henleyIdHtml}
        </div>
      `;
      
      return card;
    }
    
    // ================================
    // ROOM INTERACTIONS
    // ================================
    function toggleRoom(roomKey) {
      currentConfig[roomKey].enabled = !currentConfig[roomKey].enabled;
      
      const card = document.getElementById(`card-${roomKey}`);
      if (currentConfig[roomKey].enabled) {
        card.classList.remove('disabled');
      } else {
        card.classList.add('disabled');
      }
    }
    
    function updateColor(roomKey, colorType, value) {
      currentConfig[roomKey][colorType] = value;
      
      // Update display
      const displayId = colorType === 'color' ? `color-${roomKey}` : `border-${roomKey}`;
      const displayEl = document.getElementById(displayId);
      if (displayEl) displayEl.textContent = value;
      
      // Update preview
      const preview = document.getElementById(`preview-${roomKey}`);
      if (preview) {
        if (colorType === 'color') {
          preview.style.background = value;
        } else {
          preview.style.borderColor = value;
        }
      }
    }
    
    function deleteRoom(roomKey) {
      const room = currentConfig[roomKey];
      if (!room) return;
      
      const confirmMessage = `Are you sure you want to delete "${room.displayName}" (${room.id})?\n\n‚ö†Ô∏è This will remove the room from all calendars.\n\nNote: Existing bookings in this room will still exist but may not display correctly.`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      delete currentConfig[roomKey];
      renderRoomsByLocation();
      showStatus(`Room "${room.displayName}" deleted. Remember to save your changes.`, 'info');
    }
    
    // ================================
    // ROOM ID GENERATION
    // ================================
    function generateRoomId(locationKey) {
      const loc = locationConfig[locationKey];
      if (!loc) return '??';
      
      const prefix = loc.prefix || '?';
      const number = loc.nextRoomNumber || 1;
      
      return `${prefix}${number}`;
    }
    
    function getNextRoomId(locationKey) {
      const loc = locationConfig[locationKey];
      if (!loc) return { id: '??', number: 1 };
      
      // Check pending changes first
      let nextNumber = pendingLocationChanges[locationKey]?.nextRoomNumber || loc.nextRoomNumber || 1;
      const prefix = pendingLocationChanges[locationKey]?.prefix || loc.prefix || '?';
      
      // Also check current rooms to ensure no collision
      const usedNumbers = [];
      Object.values(currentConfig).forEach(room => {
        if (room.location === locationKey && room.id) {
          const match = room.id.match(/(\d+)$/);
          if (match) {
            usedNumbers.push(parseInt(match[1]));
          }
        }
      });
      
      while (usedNumbers.includes(nextNumber)) {
        nextNumber++;
      }
      
      return { id: `${prefix}${nextNumber}`, number: nextNumber };
    }
    
    // ================================
    // ADD ROOM MODAL
    // ================================
    function openAddModal() {
      document.getElementById('addModal').classList.add('show');
      document.getElementById('newRoomName').value = '';
      document.getElementById('newRoomColor').value = '#90caf9';
      document.getElementById('newRoomBorder').value = '#64b5f6';
      document.getElementById('newRoomOrder').value = '10';
      
      // Populate location dropdown
      const select = document.getElementById('newRoomLocation');
      select.innerHTML = '';
      Object.entries(locationConfig).forEach(([key, loc]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = loc.name;
        select.appendChild(option);
      });
      
      updateModalPreview();
    }
    
    function closeAddModal() {
      document.getElementById('addModal').classList.remove('show');
    }
    
    function updateModalPreview() {
      const color = document.getElementById('newRoomColor').value;
      const border = document.getElementById('newRoomBorder').value;
      const name = document.getElementById('newRoomName').value || 'New Room';
      const locationKey = document.getElementById('newRoomLocation').value;
      
      const preview = document.getElementById('modalPreview');
      preview.style.background = color;
      preview.style.borderColor = border;
      preview.textContent = name;
      
      // Generate and display the room ID
      if (locationKey) {
        const { id } = getNextRoomId(locationKey);
        document.getElementById('newRoomId').value = id;
        document.getElementById('previewRoomId').textContent = id;
      }
    }
    
    function addRoom() {
      const name = document.getElementById('newRoomName').value.trim();
      const locationKey = document.getElementById('newRoomLocation').value;
      const color = document.getElementById('newRoomColor').value;
      const borderColor = document.getElementById('newRoomBorder').value;
      const order = parseInt(document.getElementById('newRoomOrder').value) || 10;
      
      if (!name) {
        alert('Please enter a room name');
        return;
      }
      
      if (!locationKey) {
        alert('Please select a location');
        return;
      }
      
      // Generate a key from the name
      const roomKey = name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
      
      // Check if key already exists
      if (currentConfig[roomKey]) {
        alert('A room with this name already exists. Please choose a different name.');
        return;
      }
      
      // Get the next room ID
      const { id, number } = getNextRoomId(locationKey);
      
      // Add the new room
      currentConfig[roomKey] = {
        id: id,
        enabled: true,
        color: color,
        borderColor: borderColor,
        displayName: name,
        location: locationKey,
        order: order
        // Note: henleyRoomId not set - would need to be configured in Firebase directly
      };
      
      // Track that we need to increment this location's nextRoomNumber
      if (!pendingLocationChanges[locationKey]) {
        pendingLocationChanges[locationKey] = { ...locationConfig[locationKey] };
      }
      pendingLocationChanges[locationKey].nextRoomNumber = number + 1;
      
      closeAddModal();
      renderRoomsByLocation();
      showStatus(`Room "${name}" (${id}) added successfully! Remember to save your changes.`, 'success');
    }
    
    // ================================
    // LOCATION SETTINGS MODAL
    // ================================
    function openSettingsModal() {
      document.getElementById('settingsModal').classList.add('show');
      
      const tbody = document.getElementById('locationSettingsBody');
      tbody.innerHTML = '';
      
      Object.entries(locationConfig).forEach(([key, loc]) => {
        // Use pending changes if available
        const displayLoc = pendingLocationChanges[key] || loc;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${displayLoc.name}</strong></td>
          <td>
            <input type="text" 
                   value="${displayLoc.prefix}" 
                   data-location="${key}"
                   data-field="prefix"
                   style="text-transform: uppercase;"
                   maxlength="4"
                   onchange="updateLocationSetting(this)">
          </td>
          <td class="next-room">${displayLoc.nextRoomNumber || 1}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('show');
    }
    
    function updateLocationSetting(input) {
      const locationKey = input.dataset.location;
      const field = input.dataset.field;
      const value = input.value.toUpperCase();
      
      if (!pendingLocationChanges[locationKey]) {
        pendingLocationChanges[locationKey] = { ...locationConfig[locationKey] };
      }
      pendingLocationChanges[locationKey][field] = value;
    }
    
    function saveLocationSettings() {
      // Apply pending changes to locationConfig
      Object.entries(pendingLocationChanges).forEach(([key, changes]) => {
        if (locationConfig[key]) {
          Object.assign(locationConfig[key], changes);
        } else {
          locationConfig[key] = changes;
        }
      });
      
      closeSettingsModal();
      populateLocationFilter();
      renderRoomsByLocation();
      showStatus('Location settings updated. Remember to save all changes.', 'info');
    }
    
    // ================================
    // ADD LOCATION MODAL
    // ================================
    function openAddLocationModal() {
      closeSettingsModal();
      document.getElementById('addLocationModal').classList.add('show');
      document.getElementById('newLocationKey').value = '';
      document.getElementById('newLocationName').value = '';
      document.getElementById('newLocationPrefix').value = '';
    }
    
    function closeAddLocationModal() {
      document.getElementById('addLocationModal').classList.remove('show');
      openSettingsModal();
    }
    
    function addLocation() {
      const key = document.getElementById('newLocationKey').value.trim().toLowerCase().replace(/\s+/g, '_');
      const name = document.getElementById('newLocationName').value.trim();
      const prefix = document.getElementById('newLocationPrefix').value.trim().toUpperCase();
      
      if (!key || !name || !prefix) {
        alert('Please fill in all fields');
        return;
      }
      
      if (locationConfig[key]) {
        alert('A location with this key already exists');
        return;
      }
      
      // Check prefix uniqueness
      const existingPrefixes = Object.values(locationConfig).map(l => l.prefix);
      if (existingPrefixes.includes(prefix)) {
        alert('This prefix is already in use by another location');
        return;
      }
      
      // Add to config
      locationConfig[key] = {
        name: name,
        prefix: prefix,
        nextRoomNumber: 1
      };
      
      closeAddLocationModal();
      populateLocationFilter();
      showStatus(`Location "${name}" added. Remember to save all changes.`, 'success');
    }
    
    // ================================
    // SAVE ALL SETTINGS
    // ================================
    async function saveSettings() {
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '‚è≥ Saving...';
      showStatus('Saving configuration...', 'info');
      
      try {
        // Apply any pending location changes
        Object.entries(pendingLocationChanges).forEach(([key, changes]) => {
          if (locationConfig[key]) {
            Object.assign(locationConfig[key], changes);
          }
        });
        pendingLocationChanges = {};
        
        // Save both configs
        await Promise.all([
          database.ref('location_config').set(locationConfig),
          database.ref('room_config').set(currentConfig)
        ]);
        
        showStatus('‚úÖ All settings saved successfully! Changes will appear on all calendars.', 'success');
        
        setTimeout(() => {
          hideStatus();
        }, 4000);
        
      } catch (error) {
        console.error('Error saving:', error);
        showStatus('‚ùå Error saving settings. Please try again.', 'error');
      }
      
      saveBtn.disabled = false;
      saveBtn.textContent = 'üíæ Save All Changes';
    }
    
    // ================================
    // STATUS MESSAGES
    // ================================
    function showStatus(message, type) {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = `status-message show ${type}`;
    }
    
    function hideStatus() {
      document.getElementById('statusMessage').classList.remove('show');
    }
    
    // Close modals when clicking outside
    document.getElementById('addModal').addEventListener('click', function(e) {
      if (e.target === this) closeAddModal();
    });
    
    document.getElementById('settingsModal').addEventListener('click', function(e) {
      if (e.target === this) closeSettingsModal();
    });
    
    document.getElementById('addLocationModal').addEventListener('click', function(e) {
      if (e.target === this) closeAddLocationModal();
    });
  </script>
</body>
</html>
