<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Management - Cherry Tree Centre</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f6fa;
      min-height: 100vh;
    }
    
    /* Header */
    .admin-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .header-left h1 {
      font-size: 20px;
      font-weight: 500;
    }
    
    .back-link {
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 14px;
    }
    
    .back-link:hover {
      color: white;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .search-box {
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
      min-width: 180px;
    }
    
    .search-box::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .filter-select {
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
    }
    
    .filter-select option {
      background: #1a1a2e;
      color: white;
    }
    
    .add-btn {
      background: #007bff;
      border: none;
      color: white;
      padding: 12px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }
    
    .add-btn:hover {
      background: #0056b3;
    }
    
    /* Main Content */
    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }
    
    /* Stats Bar */
    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      min-width: 150px;
    }
    
    .stat-card .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a2e;
    }
    
    .stat-card .stat-label {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
    }
    
    .stat-card.active .stat-value { color: #28a745; }
    .stat-card.inactive .stat-value { color: #dc3545; }
    .stat-card.with-token .stat-value { color: #007bff; }
    
    /* Status Message */
    .status-message {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .status-message.show {
      display: block;
    }
    
    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-message.info {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    /* Clients Table */
    .clients-table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    .table-scroll {
      overflow-x: auto;
    }
    
    .clients-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1100px;
    }
    
    .clients-table th {
      background: #f8f9fa;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: #666;
      border-bottom: 2px solid #eee;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }
    
    .clients-table th.sortable {
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    
    .clients-table th.sortable:hover {
      background: #e9ecef;
      color: #333;
    }
    
    .sort-icon {
      margin-left: 5px;
      font-size: 10px;
      color: #999;
    }
    
    .sort-icon.asc::after {
      content: '‚ñ≤';
      color: #007bff;
    }
    
    .sort-icon.desc::after {
      content: '‚ñº';
      color: #007bff;
    }
    
    .location-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    
    .location-badge {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .location-badge.henley { background: #e8f5e9; color: #388e3c; }
    .location-badge.buckhurst_hill { background: #fff3e0; color: #f57c00; }
    .location-badge.oxford { background: #f3e5f5; color: #7b1fa2; }
    
    .clients-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    
    .clients-table tr:hover {
      background: #f8f9fa;
    }
    
    .client-id {
      font-family: 'Courier New', monospace;
      background: #e9ecef;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .client-name {
      font-weight: 600;
      color: #007bff;
      cursor: pointer;
      text-decoration: none;
    }
    
    .client-name:hover {
      text-decoration: underline;
    }
    
    .client-email {
      color: #666;
      font-size: 13px;
    }
    
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-badge.active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-badge.inactive {
      background: #f8d7da;
      color: #721c24;
    }
    
    .token-badge {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #666;
      background: #f8f9fa;
      padding: 3px 8px;
      border-radius: 4px;
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
    }
    
    .token-badge.no-token {
      color: #999;
      font-style: italic;
    }
    
    .last-booking {
      font-size: 12px;
      color: #666;
    }
    
    .last-booking.recent {
      color: #28a745;
      font-weight: 600;
    }
    
    .last-booking.old {
      color: #dc3545;
    }
    
    .last-booking.medium {
      color: #ffc107;
    }
    
    .booking-count {
      font-weight: 600;
      color: #1a1a2e;
    }
    
    .action-btns {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      background: none;
      border: 1px solid #ddd;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .action-btn:hover {
      background: #f8f9fa;
    }
    
    .action-btn.edit {
      color: #007bff;
      border-color: #007bff;
    }
    
    .action-btn.edit:hover {
      background: #007bff;
      color: white;
    }
    
    .action-btn.token {
      color: #28a745;
      border-color: #28a745;
    }
    
    .action-btn.token:hover {
      background: #28a745;
      color: white;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #eee;
      border-top-color: #1a1a2e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 550px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s;
    }
    
    .modal.large {
      max-width: 850px;
    }
    
    .modal-overlay.show .modal {
      transform: scale(1);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      font-size: 18px;
      font-weight: 500;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #007bff;
    }
    
    .form-group input:disabled {
      background: #e9ecef;
      color: #495057;
    }
    
    .form-group small {
      color: #666;
      font-size: 12px;
      margin-top: 5px;
      display: block;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 8px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .toggle-label {
      font-weight: 600;
      color: #333;
    }
    
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 26px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    input:checked + .toggle-slider {
      background-color: #28a745;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    .token-display {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .token-display code {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      word-break: break-all;
      display: block;
      margin-bottom: 10px;
    }
    
    .token-display .copy-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .token-display .copy-btn:hover {
      background: #0056b3;
    }
    
    .modal-footer {
      padding: 20px 25px;
      background: #f8f9fa;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      border-top: 1px solid #eee;
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    /* Tabs */
    .modal-tabs {
      display: flex;
      border-bottom: 2px solid #eee;
      margin: -25px -25px 25px -25px;
      padding: 0 25px;
    }
    
    .modal-tab {
      padding: 15px 25px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    
    .modal-tab:hover {
      color: #1a1a2e;
    }
    
    .modal-tab.active {
      color: #007bff;
      border-bottom-color: #007bff;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Analysis Section */
    .analysis-section {
      padding-top: 10px;
    }
    
    .analysis-section h3 {
      color: #1a1a2e;
      font-size: 16px;
      margin-bottom: 20px;
    }
    
    .analysis-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .analysis-stat {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .analysis-stat .value {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a2e;
    }
    
    .analysis-stat .value.good { color: #28a745; }
    .analysis-stat .value.warn { color: #ffc107; }
    .analysis-stat .value.bad { color: #dc3545; }
    
    .analysis-stat .label {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
    }
    
    .chart-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      height: 280px;
    }
    
    /* No results */
    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    /* Mobile Styles */
    @media (max-width: 768px) {
      .admin-header {
        padding: 10px 12px;
      }
      
      .header-controls {
        width: 100%;
      }
      
      .search-box {
        width: 100%;
      }
      
      .main-content {
        padding: 15px;
      }
      
      .stats-bar {
        gap: 10px;
      }
      
      .stat-card {
        min-width: calc(50% - 10px);
        padding: 15px;
      }
      
      .clients-table th,
      .clients-table td {
        padding: 10px 8px;
        font-size: 12px;
      }
      
      .form-row, .form-row-3 {
        grid-template-columns: 1fr;
      }
      
      .analysis-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .modal-tabs {
        overflow-x: auto;
      }
      
      .modal-tab {
        padding: 12px 15px;
        font-size: 13px;
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="header-left">
      <a href="admin-index.html" class="back-link">‚Üê Admin Portal</a>
      <h1>üë• Client Management</h1>
    </div>
    <div class="header-controls">
      <input type="text" class="search-box" id="searchBox" placeholder="Search by name or email..." oninput="filterClients()">
      <select class="filter-select" id="locationFilter" onchange="filterClients()">
        <option value="all">All Locations</option>
      </select>
      <select class="filter-select" id="statusFilter" onchange="filterClients()">
        <option value="all">All Status</option>
        <option value="active">Active Only</option>
        <option value="inactive">Inactive Only</option>
        <option value="with-token">With Token</option>
        <option value="no-token">No Token</option>
        <option value="recent">Booked Recently (30 days)</option>
        <option value="dormant">No Booking 30+ Days</option>
      </select>
      <select class="filter-select" id="sortSelect" onchange="filterClients()">
        <option value="name-asc">Sort: Name A-Z</option>
        <option value="name-desc">Sort: Name Z-A</option>
        <option value="id-asc">Sort: ID ‚Üë</option>
        <option value="id-desc">Sort: ID ‚Üì</option>
        <option value="bookings-desc">Sort: Most Bookings</option>
        <option value="bookings-asc">Sort: Least Bookings</option>
        <option value="last-desc">Sort: Recent Activity</option>
        <option value="last-asc">Sort: Oldest Activity</option>
      </select>
      <button class="add-btn" onclick="openAddModal()">‚ûï Add Client</button>
    </div>
  </header>
  
  <main class="main-content">
    <div class="stats-bar" id="statsBar">
      <div class="stat-card">
        <div class="stat-value" id="totalCount">-</div>
        <div class="stat-label">Total Clients</div>
      </div>
      <div class="stat-card active">
        <div class="stat-value" id="activeCount">-</div>
        <div class="stat-label">Active</div>
      </div>
      <div class="stat-card inactive">
        <div class="stat-value" id="inactiveCount">-</div>
        <div class="stat-label">Inactive</div>
      </div>
      <div class="stat-card with-token">
        <div class="stat-value" id="tokenCount">-</div>
        <div class="stat-label">With Token</div>
      </div>
      <div class="stat-card" style="border-left: 3px solid #17a2b8;">
        <div class="stat-value" id="bookedRecentCount" style="color: #17a2b8;">-</div>
        <div class="stat-label">Booked (30 days)</div>
      </div>
    </div>
    
    <div class="status-message" id="statusMessage"></div>
    
    <div class="results-count" id="resultsCount" style="margin-bottom: 15px; color: #666; font-size: 14px;"></div>
    
    <div class="clients-table-container">
      <div class="table-scroll">
        <table class="clients-table">
          <thead>
            <tr>
              <th class="sortable" onclick="sortBy('id')">ID <span class="sort-icon" data-col="id"></span></th>
              <th class="sortable" onclick="sortBy('name')">Name <span class="sort-icon" data-col="name"></span></th>
              <th>Email</th>
              <th>Location</th>
              <th class="sortable" onclick="sortBy('status')">Status <span class="sort-icon" data-col="status"></span></th>
              <th class="sortable" onclick="sortBy('last')">Last Booking <span class="sort-icon" data-col="last"></span></th>
              <th class="sortable" onclick="sortBy('bookings')">Bookings (6mo) <span class="sort-icon" data-col="bookings"></span></th>
              <th>Token</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="clientsTableBody">
            <tr>
              <td colspan="9">
                <div class="loading">
                  <div class="loading-spinner"></div>
                  Loading clients...
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
  
  <!-- Add/Edit Client Modal with Tabs -->
  <div class="modal-overlay" id="clientModal">
    <div class="modal large">
      <div class="modal-header">
        <h2 id="modalTitle">‚ûï Add New Client</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Tabs -->
        <div class="modal-tabs" id="modalTabs">
          <button class="modal-tab active" onclick="switchTab('details')">Details</button>
          <button class="modal-tab" onclick="switchTab('analysis')" id="analysisTabBtn" style="display: none;">üìä Analysis</button>
        </div>
        
        <!-- Details Tab -->
        <div class="tab-content active" id="detailsTab">
          <input type="hidden" id="editClientId">
          
          <div class="form-row">
            <div class="form-group">
              <label>Client ID</label>
              <input type="text" id="clientIdDisplay" disabled>
              <small>Auto-generated, cannot be changed</small>
            </div>
            <div class="form-group">
              <label>FreeAgent ID</label>
              <input type="text" id="clientFreeAgentId" placeholder="e.g. 12345678">
              <small>For accounting integration</small>
            </div>
          </div>
          
          <div class="form-group">
            <label>Name *</label>
            <input type="text" id="clientName" placeholder="Full name">
          </div>
          
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="clientEmail" placeholder="email@example.com">
          </div>
          
          <div class="toggle-row">
            <span class="toggle-label">Active</span>
            <label class="toggle-switch">
              <input type="checkbox" id="clientActive" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="form-group">
            <label>Locations</label>
            <div class="checkbox-group" id="locationCheckboxes">
              <!-- Populated dynamically -->
            </div>
          </div>
          
          <div class="form-row-3">
            <div class="form-group">
              <label>Henley SBM ID</label>
              <input type="text" id="clientHenleyId" placeholder="e.g. 16">
              <small>For transition</small>
            </div>
            <div class="form-group">
              <label>New System ID</label>
              <input type="text" id="clientNewSystemId" disabled>
              <small>Legacy reference</small>
            </div>
            <div class="form-group">
              <label>Last Booking</label>
              <input type="text" id="clientLastBooking" disabled>
              <small>Auto-calculated</small>
            </div>
          </div>
          
          <div class="form-group" id="tokenSection" style="display: none;">
            <label>Access Token</label>
            <div class="token-display">
              <code id="tokenDisplay">No token assigned</code>
              <button class="copy-btn" onclick="copyToken()">üìã Copy Token</button>
            </div>
          </div>
        </div>
        
        <!-- Analysis Tab -->
        <div class="tab-content" id="analysisTabContent">
          <div class="analysis-section">
            <h3>üìä Booking Analysis for <span id="analysisClientName"></span></h3>
            
            <div class="analysis-stats">
              <div class="analysis-stat">
                <div class="value" id="totalBookingsCount">-</div>
                <div class="label">Total All Time</div>
              </div>
              <div class="analysis-stat">
                <div class="value" id="last6MonthsCount">-</div>
                <div class="label">Last 6 Months</div>
              </div>
              <div class="analysis-stat">
                <div class="value" id="weeklyAverage">-</div>
                <div class="label">Avg Per Week</div>
              </div>
              <div class="analysis-stat">
                <div class="value" id="lastBookingDays">-</div>
                <div class="label">Days Since Last</div>
              </div>
            </div>
            
            <h4 style="margin-bottom: 15px; color: #666; font-size: 14px;">üìà Bookings Per Month (Last 6 Months)</h4>
            <div class="chart-container">
              <canvas id="bookingChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-success" id="generateTokenBtn" onclick="generateNewToken()" style="display: none;">üîë Generate Token</button>
        <button class="btn btn-primary" onclick="saveClient()">Save Client</button>
      </div>
    </div>
  </div>
  
  <!-- Token Link Modal -->
  <div class="modal-overlay" id="tokenModal">
    <div class="modal">
      <div class="modal-header">
        <h2>üîó Client Access Link</h2>
        <button class="modal-close" onclick="closeTokenModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 15px; color: #666;">Share this link with the client to access their booking calendar:</p>
        
        <div class="form-group">
          <label>Calendar Link</label>
          <div class="token-display">
            <code id="calendarLink">-</code>
            <button class="copy-btn" onclick="copyCalendarLink()">üìã Copy Link</button>
          </div>
        </div>
        
        <div class="form-group">
          <label>Raw Token</label>
          <div class="token-display">
            <code id="rawToken">-</code>
            <button class="copy-btn" onclick="copyRawToken()">üìã Copy Token</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeTokenModal()">Done</button>
      </div>
    </div>
  </div>
  
  <script>
    // ================================
    // CONFIGURATION
    // ================================
    const firebaseConfig = {
      apiKey: "AIzaSyCVp4QDAnh5RcxGZIrEY2LriUWKQNcNbzE",
      authDomain: "cherry-tree-bookings.firebaseapp.com",
      databaseURL: "https://cherry-tree-bookings-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cherry-tree-bookings",
      storageBucket: "cherry-tree-bookings.firebasestorage.app",
      messagingSenderId: "280166213685",
      appId: "1:280166213685:web:f80b11799f41f5f385297c"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    const CALENDAR_BASE_URL = 'https://bredman31.github.io/booking-changes/index.html';
    
    let clients = {};
    let bookings = [];
    let locationConfig = {};
    let nextClientNumber = 1;
    let bookingChart = null;
    let clientBookingStats = {};  // Cache for booking stats per client
    
    // ================================
    // INITIALIZATION
    // ================================
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
    
    // ================================
    // DATA LOADING
    // ================================
    async function loadData() {
      try {
        // Load all data in parallel
        const [locSnap, clientsSnap, bookingsSnap] = await Promise.all([
          database.ref('location_config').once('value'),
          database.ref('clients').once('value'),
          database.ref('bookings').once('value')
        ]);
        
        locationConfig = locSnap.val() || {
          henley: { name: 'Henley', prefix: 'H' },
          buckhurst_hill: { name: 'Buckhurst Hill', prefix: 'BH' }
        };
        
        // Populate location filter dropdown
        populateLocationFilter();
        
        clients = clientsSnap.val() || {};
        
        // Process bookings
        const bookingsData = bookingsSnap.val() || [];
        bookings = Array.isArray(bookingsData) ? bookingsData : Object.values(bookingsData);
        bookings = bookings.filter(b => b && b.status !== 'cancelled' && b.status !== 'cancel');
        
        // Calculate booking stats for each client
        calculateClientBookingStats();
        
        // Calculate next client number
        Object.keys(clients).forEach(id => {
          const match = id.match(/C(\d+)/);
          if (match) {
            const num = parseInt(match[1]);
            if (num >= nextClientNumber) {
              nextClientNumber = num + 1;
            }
          }
        });
        
        updateStats();
        renderClients();
        
      } catch (error) {
        console.error('Error loading data:', error);
        showStatus('Error loading data: ' + error.message, 'error');
      }
    }
    
    // ================================
    // BOOKING STATS CALCULATION
    // ================================
    function calculateClientBookingStats() {
      clientBookingStats = {};
      
      const now = new Date();
      const sixMonthsAgo = new Date(now);
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      
      const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      
      // Initialize stats for each client
      Object.entries(clients).forEach(([clientId, client]) => {
        clientBookingStats[clientId] = {
          total: 0,
          last6Months: 0,
          thisMonth: 0,
          lastBookingDate: null,
          monthlyData: {}
        };
        
        // Initialize monthly data for past 6 months
        for (let i = 5; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          clientBookingStats[clientId].monthlyData[key] = 0;
        }
      });
      
      // Process bookings
      bookings.forEach(booking => {
        if (!booking.client) return;
        
        // Find client by name (case insensitive)
        const clientEntry = Object.entries(clients).find(([id, c]) => 
          c.name && c.name.toLowerCase() === booking.client.toLowerCase()
        );
        
        if (!clientEntry) return;
        
        const [clientId, client] = clientEntry;
        const stats = clientBookingStats[clientId];
        
        if (!stats) return;
        
        const bookingDate = new Date(booking.date + 'T12:00:00');
        
        // Total count
        stats.total++;
        
        // Last 6 months
        if (bookingDate >= sixMonthsAgo) {
          stats.last6Months++;
          
          // Monthly breakdown
          const monthKey = `${bookingDate.getFullYear()}-${String(bookingDate.getMonth() + 1).padStart(2, '0')}`;
          if (stats.monthlyData[monthKey] !== undefined) {
            stats.monthlyData[monthKey]++;
          }
        }
        
        // This month
        if (bookingDate >= thisMonthStart) {
          stats.thisMonth++;
        }
        
        // Track last booking
        if (!stats.lastBookingDate || bookingDate > stats.lastBookingDate) {
          stats.lastBookingDate = bookingDate;
        }
      });
    }
    
    // ================================
    // STATS
    // ================================
    function updateStats() {
      const clientList = Object.values(clients);
      const total = clientList.length;
      const active = clientList.filter(c => c.active).length;
      const inactive = total - active;
      const withToken = clientList.filter(c => c.token).length;
      
      // Count clients who booked in last 30 days
      const now = new Date();
      const thirtyDaysAgo = new Date(now);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      let bookedRecent = 0;
      Object.keys(clients).forEach(id => {
        const stats = clientBookingStats[id] || {};
        if (stats.lastBookingDate && stats.lastBookingDate >= thirtyDaysAgo) {
          bookedRecent++;
        }
      });
      
      document.getElementById('totalCount').textContent = total;
      document.getElementById('activeCount').textContent = active;
      document.getElementById('inactiveCount').textContent = inactive;
      document.getElementById('tokenCount').textContent = withToken;
      document.getElementById('bookedRecentCount').textContent = bookedRecent;
    }
    
    // ================================
    // RENDERING
    // ================================
    function renderClients() {
      const tbody = document.getElementById('clientsTableBody');
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const locationFilter = document.getElementById('locationFilter').value;
      const sortOption = document.getElementById('sortSelect').value;
      
      const now = new Date();
      const thirtyDaysAgo = new Date(now);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      // Filter clients
      let filteredClients = Object.entries(clients).filter(([id, client]) => {
        // Search filter
        const matchesSearch = !searchTerm || 
          client.name?.toLowerCase().includes(searchTerm) ||
          client.email?.toLowerCase().includes(searchTerm) ||
          id.toLowerCase().includes(searchTerm);
        
        // Location filter
        const clientLocations = client.locations || ['henley'];
        const matchesLocation = locationFilter === 'all' || clientLocations.includes(locationFilter);
        
        // Get booking stats
        const stats = clientBookingStats[id] || {};
        
        // Status filter
        let matchesStatus = true;
        if (statusFilter === 'active') matchesStatus = client.active;
        else if (statusFilter === 'inactive') matchesStatus = !client.active;
        else if (statusFilter === 'with-token') matchesStatus = !!client.token;
        else if (statusFilter === 'no-token') matchesStatus = !client.token;
        else if (statusFilter === 'recent') matchesStatus = stats.lastBookingDate && stats.lastBookingDate >= thirtyDaysAgo;
        else if (statusFilter === 'dormant') matchesStatus = !stats.lastBookingDate || stats.lastBookingDate < thirtyDaysAgo;
        
        return matchesSearch && matchesStatus && matchesLocation;
      });
      
      // Sort clients
      const [sortField, sortDir] = sortOption.split('-');
      filteredClients.sort((a, b) => {
        const [idA, clientA] = a;
        const [idB, clientB] = b;
        const statsA = clientBookingStats[idA] || {};
        const statsB = clientBookingStats[idB] || {};
        
        let comparison = 0;
        
        switch (sortField) {
          case 'name':
            comparison = (clientA.name || '').localeCompare(clientB.name || '');
            break;
          case 'id':
            comparison = idA.localeCompare(idB);
            break;
          case 'status':
            comparison = (clientA.active ? 1 : 0) - (clientB.active ? 1 : 0);
            break;
          case 'bookings':
            comparison = (statsA.last6Months || 0) - (statsB.last6Months || 0);
            break;
          case 'last':
            const dateA = statsA.lastBookingDate ? statsA.lastBookingDate.getTime() : 0;
            const dateB = statsB.lastBookingDate ? statsB.lastBookingDate.getTime() : 0;
            comparison = dateA - dateB;
            break;
          default:
            comparison = (clientA.name || '').localeCompare(clientB.name || '');
        }
        
        return sortDir === 'desc' ? -comparison : comparison;
      });
      
      // Update sort icons
      updateSortIcons(sortField, sortDir);
      
      // Show results count
      const totalClients = Object.keys(clients).length;
      const filteredCount = filteredClients.length;
      const resultsEl = document.getElementById('resultsCount');
      if (filteredCount === totalClients) {
        resultsEl.textContent = `Showing all ${totalClients} clients`;
      } else {
        resultsEl.textContent = `Showing ${filteredCount} of ${totalClients} clients`;
      }
      
      if (filteredClients.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9">
              <div class="no-results">No clients found matching your criteria.</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = filteredClients.map(([id, client]) => {
        const stats = clientBookingStats[id] || {};
        const clientLocations = client.locations || ['henley'];
        
        // Format last booking
        let lastBookingHtml = '<span class="last-booking">Never</span>';
        if (stats.lastBookingDate) {
          const daysSince = Math.floor((now - stats.lastBookingDate) / (1000 * 60 * 60 * 24));
          const dateStr = stats.lastBookingDate.toLocaleDateString('en-GB');
          let colorClass = 'recent';
          if (daysSince > 60) colorClass = 'old';
          else if (daysSince > 30) colorClass = 'medium';
          lastBookingHtml = `<span class="last-booking ${colorClass}" title="${daysSince} days ago">${dateStr}</span>`;
        }
        
        // Format locations
        const locationBadges = clientLocations.map(loc => {
          const locName = locationConfig[loc]?.name || loc;
          return `<span class="location-badge ${loc}">${locName}</span>`;
        }).join('');
        
        return `
          <tr>
            <td><span class="client-id">${id}</span></td>
            <td><a class="client-name" onclick="openClientAnalysis('${id}')">${client.name || '-'}</a></td>
            <td><span class="client-email">${client.email || '-'}</span></td>
            <td><div class="location-badges">${locationBadges}</div></td>
            <td>
              <span class="status-badge ${client.active ? 'active' : 'inactive'}">
                ${client.active ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td>${lastBookingHtml}</td>
            <td><span class="booking-count">${stats.last6Months || 0}</span></td>
            <td>
              ${client.token 
                ? `<span class="token-badge">${client.token.substring(0, 8)}...</span>`
                : `<span class="token-badge no-token">No token</span>`
              }
            </td>
            <td>
              <div class="action-btns">
                <button class="action-btn edit" onclick="editClient('${id}')">Edit</button>
                ${client.token 
                  ? `<button class="action-btn token" onclick="showToken('${id}')">üîó</button>`
                  : `<button class="action-btn token" onclick="generateTokenFor('${id}')">+üîë</button>`
                }
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function updateSortIcons(activeField, activeDir) {
      document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.className = 'sort-icon';
        if (icon.dataset.col === activeField) {
          icon.classList.add(activeDir);
        }
      });
    }
    
    function sortBy(field) {
      const sortSelect = document.getElementById('sortSelect');
      const currentValue = sortSelect.value;
      const [currentField, currentDir] = currentValue.split('-');
      
      // Toggle direction if same field, otherwise default to asc (or desc for bookings/last)
      let newDir;
      if (currentField === field) {
        newDir = currentDir === 'asc' ? 'desc' : 'asc';
      } else {
        // Default directions
        newDir = (field === 'bookings' || field === 'last') ? 'desc' : 'asc';
      }
      
      sortSelect.value = `${field}-${newDir}`;
      filterClients();
    }
    
    function populateLocationFilter() {
      const select = document.getElementById('locationFilter');
      select.innerHTML = '<option value="all">All Locations</option>';
      
      Object.entries(locationConfig).forEach(([key, loc]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = loc.name;
        select.appendChild(option);
      });
    }
    
    function filterClients() {
      renderClients();
    }
    
    // ================================
    // TAB SWITCHING
    // ================================
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.modal-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName === 'details' ? 'detailsTab' : 'analysisTabContent').classList.add('active');
    }
    
    // ================================
    // CLIENT ANALYSIS (via name click)
    // ================================
    function openClientAnalysis(clientId) {
      const client = clients[clientId];
      if (!client) return;
      
      // Populate edit form first
      populateEditForm(clientId, client);
      
      // Show analysis tab
      document.getElementById('analysisTabBtn').style.display = 'block';
      
      // Populate analysis data
      populateAnalysis(clientId, client.name);
      
      // Switch to analysis tab
      switchTab('analysis');
      
      document.getElementById('clientModal').classList.add('show');
    }
    
    function populateAnalysis(clientId, clientName) {
      const stats = clientBookingStats[clientId] || {};
      
      // Update name
      document.getElementById('analysisClientName').textContent = clientName || 'Unknown';
      
      // Update stats
      document.getElementById('totalBookingsCount').textContent = stats.total || 0;
      document.getElementById('last6MonthsCount').textContent = stats.last6Months || 0;
      
      // Weekly average (last 6 months = ~26 weeks)
      const weeklyAvg = stats.last6Months ? (stats.last6Months / 26).toFixed(1) : '0';
      document.getElementById('weeklyAverage').textContent = weeklyAvg;
      
      // Days since last booking
      const daysEl = document.getElementById('lastBookingDays');
      if (stats.lastBookingDate) {
        const daysSince = Math.floor((new Date() - stats.lastBookingDate) / (1000 * 60 * 60 * 24));
        daysEl.textContent = daysSince;
        
        // Color code
        daysEl.className = 'value';
        if (daysSince <= 14) daysEl.classList.add('good');
        else if (daysSince <= 30) daysEl.classList.add('warn');
        else daysEl.classList.add('bad');
      } else {
        daysEl.textContent = 'Never';
        daysEl.className = 'value bad';
      }
      
      // Create chart
      createBookingChart(stats.monthlyData || {});
    }
    
    function createBookingChart(monthlyData) {
      const canvas = document.getElementById('bookingChart');
      const ctx = canvas.getContext('2d');
      
      // Destroy existing chart
      if (bookingChart) {
        bookingChart.destroy();
      }
      
      // Prepare data
      const labels = [];
      const data = [];
      
      const now = new Date();
      for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        const monthName = d.toLocaleDateString('en-GB', { month: 'short', year: '2-digit' });
        
        labels.push(monthName);
        data.push(monthlyData[key] || 0);
      }
      
      bookingChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Bookings',
            data: data,
            backgroundColor: 'rgba(0, 123, 255, 0.7)',
            borderColor: 'rgba(0, 123, 255, 1)',
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
    
    // ================================
    // ADD/EDIT CLIENT
    // ================================
    function openAddModal() {
      document.getElementById('modalTitle').textContent = '‚ûï Add New Client';
      document.getElementById('editClientId').value = '';
      document.getElementById('clientIdDisplay').value = `C${String(nextClientNumber).padStart(3, '0')}`;
      document.getElementById('clientName').value = '';
      document.getElementById('clientEmail').value = '';
      document.getElementById('clientActive').checked = true;
      document.getElementById('clientHenleyId').value = '';
      document.getElementById('clientNewSystemId').value = '';
      document.getElementById('clientFreeAgentId').value = '';
      document.getElementById('clientLastBooking').value = 'N/A';
      document.getElementById('tokenSection').style.display = 'none';
      document.getElementById('generateTokenBtn').style.display = 'none';
      document.getElementById('analysisTabBtn').style.display = 'none';
      
      populateLocationCheckboxes([]);
      switchTab('details');
      
      document.getElementById('clientModal').classList.add('show');
    }
    
    function editClient(clientId) {
      const client = clients[clientId];
      if (!client) return;
      
      populateEditForm(clientId, client);
      
      // Show analysis tab for existing clients
      document.getElementById('analysisTabBtn').style.display = 'block';
      
      // Also populate analysis in case they switch tab
      populateAnalysis(clientId, client.name);
      
      switchTab('details');
      document.getElementById('clientModal').classList.add('show');
    }
    
    function populateEditForm(clientId, client) {
      document.getElementById('modalTitle').textContent = '‚úèÔ∏è ' + (client.name || 'Edit Client');
      document.getElementById('editClientId').value = clientId;
      document.getElementById('clientIdDisplay').value = clientId;
      document.getElementById('clientName').value = client.name || '';
      document.getElementById('clientEmail').value = client.email || '';
      document.getElementById('clientActive').checked = client.active !== false;
      document.getElementById('clientHenleyId').value = client.henleyClientId || '';
      document.getElementById('clientNewSystemId').value = client.newSystemId || '';
      document.getElementById('clientFreeAgentId').value = client.freeAgentId || '';
      
      // Last booking
      const stats = clientBookingStats[clientId] || {};
      if (stats.lastBookingDate) {
        document.getElementById('clientLastBooking').value = stats.lastBookingDate.toLocaleDateString('en-GB');
      } else {
        document.getElementById('clientLastBooking').value = 'Never';
      }
      
      populateLocationCheckboxes(client.locations || []);
      
      // Show token section if exists
      if (client.token) {
        document.getElementById('tokenSection').style.display = 'block';
        document.getElementById('tokenDisplay').textContent = client.token;
        document.getElementById('generateTokenBtn').style.display = 'inline-block';
        document.getElementById('generateTokenBtn').textContent = 'üîÑ Regenerate Token';
      } else {
        document.getElementById('tokenSection').style.display = 'none';
        document.getElementById('generateTokenBtn').style.display = 'inline-block';
        document.getElementById('generateTokenBtn').textContent = 'üîë Generate Token';
      }
    }
    
    function populateLocationCheckboxes(selectedLocations) {
      const container = document.getElementById('locationCheckboxes');
      container.innerHTML = '';
      
      Object.entries(locationConfig).forEach(([key, loc]) => {
        const checked = selectedLocations.includes(key) ? 'checked' : '';
        container.innerHTML += `
          <label class="checkbox-item">
            <input type="checkbox" value="${key}" ${checked}>
            ${loc.name}
          </label>
        `;
      });
    }
    
    function closeModal() {
      document.getElementById('clientModal').classList.remove('show');
      
      // Destroy chart when closing
      if (bookingChart) {
        bookingChart.destroy();
        bookingChart = null;
      }
    }
    
    async function saveClient() {
      const editId = document.getElementById('editClientId').value;
      const clientId = editId || `C${String(nextClientNumber).padStart(3, '0')}`;
      
      const name = document.getElementById('clientName').value.trim();
      const email = document.getElementById('clientEmail').value.trim();
      const active = document.getElementById('clientActive').checked;
      const henleyClientId = document.getElementById('clientHenleyId').value.trim();
      const freeAgentId = document.getElementById('clientFreeAgentId').value.trim();
      
      // Get selected locations
      const locationCheckboxes = document.querySelectorAll('#locationCheckboxes input[type="checkbox"]');
      const locations = Array.from(locationCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
      
      if (!name || !email) {
        alert('Please fill in name and email');
        return;
      }
      
      // Build client object
      const clientData = {
        id: clientId,
        name: name,
        email: email,
        active: active,
        locations: locations.length > 0 ? locations : ['henley']
      };
      
      // Add optional fields if present
      if (henleyClientId) clientData.henleyClientId = henleyClientId;
      if (freeAgentId) clientData.freeAgentId = freeAgentId;
      
      // Preserve existing fields if editing
      if (editId && clients[editId]) {
        if (clients[editId].token) clientData.token = clients[editId].token;
        if (clients[editId].newSystemId) clientData.newSystemId = clients[editId].newSystemId;
        clientData.createdAt = clients[editId].createdAt || new Date().toISOString();
      } else {
        clientData.createdAt = new Date().toISOString();
      }
      
      try {
        await database.ref(`clients/${clientId}`).set(clientData);
        
        clients[clientId] = clientData;
        
        if (!editId) {
          nextClientNumber++;
        }
        
        // Recalculate stats for this client
        calculateClientBookingStats();
        
        closeModal();
        updateStats();
        renderClients();
        showStatus(`Client ${name} saved successfully!`, 'success');
        
      } catch (error) {
        console.error('Error saving client:', error);
        showStatus('Error saving client: ' + error.message, 'error');
      }
    }
    
    // ================================
    // TOKEN MANAGEMENT
    // ================================
    function generateToken() {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let token = '';
      for (let i = 0; i < 32; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return token;
    }
    
    async function generateNewToken() {
      const clientId = document.getElementById('editClientId').value;
      if (!clientId) return;
      
      const newToken = generateToken();
      
      try {
        await database.ref(`clients/${clientId}/token`).set(newToken);
        
        clients[clientId].token = newToken;
        
        document.getElementById('tokenSection').style.display = 'block';
        document.getElementById('tokenDisplay').textContent = newToken;
        document.getElementById('generateTokenBtn').textContent = 'üîÑ Regenerate Token';
        
        renderClients();
        showStatus('New token generated!', 'success');
        
      } catch (error) {
        console.error('Error generating token:', error);
        showStatus('Error generating token: ' + error.message, 'error');
      }
    }
    
    async function generateTokenFor(clientId) {
      const client = clients[clientId];
      if (!client) return;
      
      if (!confirm(`Generate access token for ${client.name}?`)) return;
      
      const newToken = generateToken();
      
      try {
        await database.ref(`clients/${clientId}/token`).set(newToken);
        
        clients[clientId].token = newToken;
        
        renderClients();
        updateStats();
        showToken(clientId);
        
      } catch (error) {
        console.error('Error generating token:', error);
        showStatus('Error generating token: ' + error.message, 'error');
      }
    }
    
    function showToken(clientId) {
      const client = clients[clientId];
      if (!client || !client.token) return;
      
      const calendarLink = `${CALENDAR_BASE_URL}?token=${client.token}`;
      
      document.getElementById('calendarLink').textContent = calendarLink;
      document.getElementById('rawToken').textContent = client.token;
      
      document.getElementById('tokenModal').classList.add('show');
    }
    
    function closeTokenModal() {
      document.getElementById('tokenModal').classList.remove('show');
    }
    
    function copyToken() {
      const token = document.getElementById('tokenDisplay').textContent;
      navigator.clipboard.writeText(token);
      showStatus('Token copied to clipboard!', 'success');
    }
    
    function copyCalendarLink() {
      const link = document.getElementById('calendarLink').textContent;
      navigator.clipboard.writeText(link);
      showStatus('Calendar link copied to clipboard!', 'success');
    }
    
    function copyRawToken() {
      const token = document.getElementById('rawToken').textContent;
      navigator.clipboard.writeText(token);
      showStatus('Token copied to clipboard!', 'success');
    }
    
    // ================================
    // STATUS MESSAGES
    // ================================
    function showStatus(message, type) {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = `status-message show ${type}`;
      
      setTimeout(() => {
        el.classList.remove('show');
      }, 4000);
    }
    
    // Close modals when clicking outside
    document.getElementById('clientModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
    
    document.getElementById('tokenModal').addEventListener('click', function(e) {
      if (e.target === this) closeTokenModal();
    });
  </script>
</body>
</html>
