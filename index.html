<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cherry Tree Centre - Room Booking Calendar</title>
  
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <!-- Stylesheet -->
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- Day navigation styling -->
  <style>
    .day-navigation {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .day-navigation button {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    .day-navigation button:hover {
      background: #f0f0f0;
    }
    .day-navigation input[type="date"] {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      }
    
    /* Credit Balance Section */
    .credit-balance-section {
      margin-bottom: 15px;
    }
    
    /* Payment Choice Modal */
    #paymentChoiceModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #paymentChoiceModal .booking-modal {
      animation: slideIn 0.3s ease;
      max-width: 450px;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #paymentChoiceModal button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
  </style>
</head>
<body>


<!-- ================================ -->
<!-- SECTION 1: HTML STRUCTURE -->
<!-- ================================ -->
  <div class="header">
    <h2 id="pageTitle">Cherry Tree Centre - Room Booking Calendar</h2>
    <div class="view-selector">
      <button class="view-btn active" onclick="switchView('day')">Day View</button>
      <button class="view-btn" onclick="switchView('week')">Week View</button>
    </div>
    <div class="counsellor-filter hidden" id="counsellorFilterContainer">
      <label>Counsellor:</label>
      <select id="counsellorSelect" onchange="filterByCounsellor()">
        <option value="">All Counsellors</option>
      </select>
    </div>
  </div>
  <div class="main-container">
    <!-- Left panel: Form for modifying bookings -->
    <div class="form-container">
      <div id="counsellorInfo" class="counsellor-info hidden">
        <h3 id="counsellorName"></h3>
        <p id="counsellorSummary"></p>
      </div>
      
      <!-- Credit Balance Display -->
      <div id="creditBalanceSection" class="credit-balance-section" style="display: none;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">üí≥ Your Credit Balance</div>
              <div id="creditBalanceAmount" style="font-size: 24px; font-weight: bold;">¬£0.00</div>
            </div>
            <div style="font-size: 32px;">üí∞</div>
          </div>
          <div id="creditBalanceNote" style="font-size: 11px; opacity: 0.8; margin-top: 8px; display: none;">
            Credit from cancelled paid bookings
          </div>
        </div>
      </div>
      
      <!-- Custom booking change form -->
      <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
        <div id="normalFormHeader">
          <h3>Modify Booking</h3>
          <p style="margin-bottom: 15px; font-size: 14px; color: #666;">Click on a booking in the calendar to modify it.</p>
        </div>
        
        <form id="bookingChangeForm">
          <div id="currentBookingDisplay" style="margin-bottom: 15px;">
            <div style="font-size: 14px; line-height: 1.4;">
              <div style="margin-bottom: 8px;"><strong>Current Room:</strong> <span id="currentRoomDisplay"></span></div>
              <div id="currentDateRow" style="margin-bottom: 8px;"><strong>Current Date:</strong> <span id="currentDateDisplay"></span></div>
              <div id="currentTimeRow" style="margin-bottom: 8px;"><strong>Current Time:</strong> <span id="currentTimeDisplay"></span></div>
            </div>
          </div>
          
          <!-- Hidden fields for form submission -->
          <input type="hidden" id="bookingCodeInput">
          <input type="hidden" id="currentRoomInput">
          <input type="hidden" id="currentDateInput">
          <input type="hidden" id="currentTimeInput">
          <input type="hidden" id="counsellorNameInput">
          
          <!-- Past booking notice -->
          <div id="pastBookingNotice" class="past-booking-notice hidden">
            This booking is within 24 hours and cannot be modified or cancelled online. Please contact the centre directly.
          </div>
          
          <div id="cancelButtonSection" style="margin: 20px 0; text-align: center;">
            <button type="button" id="cancelBookingBtn" onclick="cancelBooking()" 
                    style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; width: 100%; margin-bottom: 10px;"
                    disabled>
              Cancel This Appointment
            </button>
            <div id="cancelStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none; font-size: 12px;"></div>
          </div>
          
          <hr id="formDivider" style="margin: 20px 0; border: 1px solid #ddd;">
          <h4 id="changeRequestHeader" style="margin-bottom: 15px; color: #007bff;">Or Request Changes:</h4>
          <h4 id="holdingMoveHeader" class="hidden" style="margin-bottom: 15px; color: #007bff;">Select New Location:</h4>
          
          <div style="margin-bottom: 15px;">
            <label id="roomChangeLabel" style="display: block; font-weight: bold; margin-bottom: 5px;">New Room (if changing):</label>
            <select id="newRoomInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="">No change</option>
              <option value="Room 1">Room 1</option>
              <option value="Room 2">Room 2</option>
              <option value="Room 4">Room 4</option>
              <option value="Room 5">Room 5</option>
              <option value="Room 6">Room 6</option>
              <option value="Room 7">Room 7</option>
              <option value="Room 8">Room 8</option>
              <option value="Room 9">Room 9</option>
              <option value="Online">Online</option>
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">New Date (if changing):</label>
            <input type="date" id="newDateInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">New Time (if changing):</label>
            <select id="newTimeInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="">No change</option>
              <option value="08:00">08:00</option>
              <option value="09:00">09:00</option>
              <option value="10:00">10:00</option>
              <option value="11:00">11:00</option>
              <option value="12:00">12:00</option>
              <option value="13:00">13:00</option>
              <option value="14:00">14:00</option>
              <option value="15:00">15:00</option>
              <option value="16:00">16:00</option>
              <option value="17:00">17:00</option>
              <option value="18:00">18:00</option>
              <option value="19:00">19:00</option>
              <option value="20:00">20:00</option>
            </select>
          </div>
          
          <button type="submit" id="submitChangeBtn" style="background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold;">
            Submit Change Request
          </button>
        </form>
        
        <div id="submitStatus" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
      </div>
    </div>
    
    <!-- Right panel: Calendar display -->
    <div class="calendar-section">
      <div class="calendar-container">
        <div class="controls">
          <div id="dayControls">
            <div class="day-navigation">
              <button onclick="changeDay(-1)">‚Üê¬ê Previous Day</button>
              <input type="date" id="dateSelector" />
              <button onclick="changeDay(1)">Next Day ‚Üí</button>
              <button onclick="goToToday()" style="margin-left: 10px;">Today</button>
            </div>
          </div>
          
          <div id="weekControls" class="hidden">
            <div class="week-navigation">
              <button onclick="changeWeek(-1)">‚Üê¬ê Previous Week</button>
              <span id="weekDisplay"></span>
              <button onclick="changeWeek(1)">Next Week ‚Üí</button>
            </div>
          </div>
          
          <button onclick="refreshData()">Refresh Data</button>
          <span id="dataStatus" style="margin-left: 15px; font-size: 0.9em; color: #666;"></span>
        </div>
        
        <div class="calendar-grid day-view" id="calendarGrid">
          <!-- Dynamic grid will be inserted here -->
        </div>
      </div>
     </div>
  </div>
  
  
<!-- ================================ -->
<!-- SECTION 2: NEW BOOKING MODAL -->
<!-- ================================ -->
  <div class="modal-overlay" id="newBookingModal">
    <div class="booking-modal">
      <div class="modal-header" style="position: relative;">
        <h2>üìÖ Book This Slot</h2>
        <button class="close-btn" onclick="closeNewBookingModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="booking-details">
          <div class="detail-row">
            <span class="detail-label">Room</span>
            <span class="detail-value" id="modalRoom">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Date</span>
            <span class="detail-value" id="modalDate">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Time</span>
            <span class="detail-value" id="modalTime">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Duration</span>
            <span class="detail-value" id="modalDuration">1 Hour</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Location</span>
            <span class="detail-value" id="modalLocation">-</span>
          </div>
        </div>
        
        
		<!-- Comments/Registration Field -->
        <div class="comments-field" id="commentsFieldContainer" style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px;">
          <label for="newBookingComments" id="commentsLabel" style="font-weight: 600; color: #333; display: block; margin-bottom: 5px;">
            <span id="commentsLabelText">Comments</span>
            <span id="commentsRequired" style="color: #dc3545; display: none;"> *</span>
          </label>
          <input type="text" id="newBookingComments" placeholder="Optional comments..." 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
          <small id="commentsHint" style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
            Add any notes for this booking
          </small>
        </div>
		
        <div class="price-display" id="priceDisplay">
          <div class="price-label">Room Hire Cost</div>
          <div class="price-amount" id="priceAmount">¬£0.00</div>
          <div class="price-breakdown" id="priceBreakdown">Calculating...</div>
        </div>
        
        <div class="modal-actions">
          <button class="cancel-btn" onclick="closeNewBookingModal()">Cancel</button>
          <button class="confirm-btn" id="confirmBookingBtn" onclick="confirmNewBooking()">
            Proceed to Payment
          </button>
        </div>
        
        <div class="booking-status" id="bookingStatus" style="display: none;"></div>
      </div>
    </div>
  </div>
  
<!-- ================================ -->
<!-- PAYMENT CHOICE MODAL -->
<!-- ================================ -->
  <div id="paymentChoiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div class="booking-modal" style="max-width: 450px; animation: slideIn 0.3s ease;">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h2>üí≥ Payment Options</h2>
        <button class="close-btn" onclick="closePaymentChoiceModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 25px;">
        <div id="paymentChoiceSummary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <!-- Populated dynamically -->
        </div>
        
        <!-- Option A: Pay fully with credit (shown when credit >= total) -->
        <div id="paymentOptionCredit" style="display: none; margin-bottom: 15px;">
          <button onclick="processPaymentWithCredit()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
            √¢≈ì‚Ä¶ Pay with Credit
          </button>
          <p style="text-align: center; font-size: 12px; color: #666; margin-top: 8px;">
            Use your available credit balance
          </p>
        </div>
        
        <!-- Option B: Pay with card (shown always) -->
        <div id="paymentOptionCard" style="margin-bottom: 15px;">
          <button onclick="processPaymentWithCard()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
            üí≥ Pay with Card
          </button>
          <p id="paymentOptionCardNote" style="text-align: center; font-size: 12px; color: #666; margin-top: 8px;">
            Pay the full amount by card
          </p>
        </div>
        
        <!-- Option C: Partial credit + card (shown when 0 < credit < total) -->
        <div id="paymentOptionPartial" style="display: none; margin-bottom: 15px;">
          <button onclick="processPaymentWithPartialCredit()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
            üí≥ Use Credit + Pay Remainder
          </button>
          <p id="paymentOptionPartialNote" style="text-align: center; font-size: 12px; color: #666; margin-top: 8px;">
            <!-- Populated dynamically -->
          </p>
        </div>
        
        <div id="paymentChoiceStatus" style="display: none; padding: 12px; border-radius: 6px; margin-top: 15px; text-align: center;"></div>
      </div>
    </div>
  </div>

  <!-- Hidden fields for new booking -->
  <input type="hidden" id="newBookingRoom">
  <input type="hidden" id="newBookingRoomId">
  <input type="hidden" id="newBookingDate">
  <input type="hidden" id="newBookingTime">
  <input type="hidden" id="newBookingEndTime">
  <input type="hidden" id="newBookingLocationId">
  <input type="hidden" id="newBookingPrice">
  <input type="hidden" id="newBookingServiceId">
  
  
<!-- ================================ -->
<!-- SECTION 3: GLOBAL CONFIGURATION -->
<!-- ================================ -->
  <script>
    // Google Apps Script configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxaMATLZvtAxJULI2l3teqb0u6FkBiP8LBuGMV7VrcU2NxMEbH92aj8Q4YI6aZ1GLUm4Q/exec';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCVp4QDAnh5RcxGZIrEY2LriUWKQNcNbzE",
      authDomain: "cherry-tree-bookings.firebaseapp.com",
      databaseURL: "https://cherry-tree-bookings-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cherry-tree-bookings",
      storageBucket: "cherry-tree-bookings.firebasestorage.app",
      messagingSenderId: "280166213685",
      appId: "1:280166213685:web:f80b11799f41f5f385297c"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
// Room config - loaded dynamically from Firebase via room-config.js
// Uses window.roomConfig and window.enabledRooms
const businessHours = Array.from({length: 13}, (_, i) => `${String(i + 8).padStart(2, '0')}:00`);
    const weekDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

const STRIPE_CONFIG = {
  // Your Make.com webhook that creates Stripe checkout sessions
  createCheckoutWebhook: 'https://hook.eu2.make.com/cpg4px3j3jcbj5k7ea7kniu3vfy3c7gq',
  
  // URLs for redirect after payment (auto-detected from current page)
  get successUrl() {
    const base = window.location.origin + window.location.pathname;
    const token = sessionStorage.getItem('accessToken');
    return base + '?payment=success' + (token ? '&token=' + token : '');
  },
  get cancelUrl() {
    const base = window.location.origin + window.location.pathname;
    const token = sessionStorage.getItem('accessToken');
    return base + '?payment=cancelled' + (token ? '&token=' + token : '');
  }
};
    
    // Global state variables
    let bookingData = [];
// holdingRoomBookings removed - no longer using holding room
    let currentView = 'day';
    let currentDate = new Date().toISOString().split('T')[0];
    let currentWeekStart = new Date();
    let selectedCounsellor = '';
    // Global variable for client ID from URL
    window.clientId = null;
    // Global variable for booking to modify from URL
    window.bookingToModify = null;
    // Global variable for pricing configuration
    let pricingConfig = null;

// Generate dynamic CSS for room colours
function generateRoomStyles() {
  let styleEl = document.getElementById('room-dynamic-styles');
  if (!styleEl) {
    styleEl = document.createElement('style');
    styleEl.id = 'room-dynamic-styles';
    document.head.appendChild(styleEl);
  }
  
  let css = '/* Dynamic room colours */\n';
  
  enabledRooms.forEach(room => {
    const className = room.key.toLowerCase().replace('_', '-');
    css += `.grid-cell.booked.${className} { background: ${room.color}; border-left: 4px solid ${room.borderColor}; }\n`;
  });
  
  styleEl.textContent = css;
}
	
    // Set today's date as default
    document.getElementById('dateSelector').value = currentDate;
    
    // Set current week to start on Monday
    const today = new Date();
    const dayOfWeek = today.getDay();
    let daysToSubtract;
    if (dayOfWeek === 0) {
      daysToSubtract = 6;
    } else {
      daysToSubtract = dayOfWeek - 1;
    }
    currentWeekStart = new Date(today);
    currentWeekStart.setDate(today.getDate() - daysToSubtract);
    currentWeekStart.setHours(0, 0, 0, 0);
  </script>
  
<!-- ================================ -->
<!-- SECTION 4: BASIC UTILITY FUNCTIONS -->
<!-- ================================ -->
  <script>
    // 24-hour check function
    function isBookingWithin24Hours(bookingDate, bookingTime) {
      const now = new Date();
      const bookingDateTime = new Date(`${bookingDate}T${bookingTime}:00`);
      const timeDiff = bookingDateTime.getTime() - now.getTime();
      const hoursDiff = timeDiff / (1000 * 60 * 60);
      return hoursDiff < 24;
    }
    
    // Format date and time for SimplybookMe
    function formatDateTimeForSimplybookMe(date, time) {
      if (!date || !time) {
        return '';
      }
      
      let formattedTime = time;
      if (time.length === 5) {
        formattedTime = time + ':00';
      }
      
      return `${date}T${formattedTime}`;
    }
    
    // Get location ID from room name - NOW USES DYNAMIC ROOM CONFIG
    function getLocationIdFromRoom(roomName) {
      // Normalize room name to match config keys (e.g., "Room 8" -> "Room_8")
      const normalizedName = roomName ? roomName.replace(' ', '_') : '';
      
      // Check the dynamic room config first
      if (window.roomConfig && window.roomConfig[normalizedName]) {
        const roomLocation = window.roomConfig[normalizedName].location;
        // Return '2' for Henley, '1' for Buckhurst Hill
        return roomLocation === 'henley' ? '2' : '1';
      }
      
      // Also check with original name (handles "Room 8" format)
      if (window.roomConfig) {
        for (const key in window.roomConfig) {
          const room = window.roomConfig[key];
          if (room.displayName === roomName || key === roomName) {
            return room.location === 'henley' ? '2' : '1';
          }
        }
      }
      
      // Fallback: assume Henley for unknown rooms
      console.warn('Room not found in config, defaulting to Henley:', roomName);
      return '2';
    }
    
    // Get available rooms for a specific location - NOW USES DYNAMIC ROOM CONFIG
    function getRoomsForLocation(locationId) {
      const targetLocation = locationId === '2' ? 'henley' : 'buckhurst_hill';
      const rooms = [];
      
      // Build list from dynamic room config
      if (window.roomConfig) {
        // Get rooms and sort by order
        const sortedRooms = Object.entries(window.roomConfig)
          .filter(([key, room]) => room.enabled && room.location === targetLocation)
          .sort((a, b) => (a[1].order || 99) - (b[1].order || 99));
        
        for (const [key, room] of sortedRooms) {
          rooms.push(room.displayName);
        }
      }
      
      // Fallback if config not loaded
      if (rooms.length === 0) {
        if (locationId === '1') {
          return ['Online'];
        } else {
          return ['Room 1', 'Room 2', 'Room 4', 'Room 5', 'Room 6', 'Room 7', 'Room 8', 'Room 9', 'Car Park'];
        }
      }
      
      return rooms;
    }

// Restore session state from storage - call this at start of any navigation
function restoreSessionState() {
  const token = sessionStorage.getItem('accessToken');
  const counsellorName = sessionStorage.getItem('counsellorName');
  
  if (token && counsellorName && !selectedCounsellor) {
    selectedCounsellor = counsellorName;
    console.log('Session restored: counsellor =', counsellorName);
    return true;
  }
  
  if (token && !counsellorName) {
    console.warn('Token exists but no counsellor name found');
    return false;
  }
  
  return !!token;
}
  </script>
  
<!-- ================================ -->
<!-- SECTION 4.1: TOKEN AUTHENTICATION -->
<!-- ================================ -->
  <script>
    // FIXED: Token validation function WITH DEBUGGING
    async function validateAccessToken(token) {
      console.log('üîç¬ê validateAccessToken called with token:', token);
      
      try {
        console.log('üì° Checking Firebase for token:', token);
        const snap = await database.ref('therapist_tokens/' + token).once('value');
        const t = snap.val();
        
        console.log('üì¶ Firebase returned:', t);
        
        if (t && t.active) {
          console.log('√¢≈ì‚Ä¶ Token is valid and active');
          console.log('üë§ Counsellor name:', t.name);
          console.log('üÜî Client ID:', t.clientId);
          
          sessionStorage.setItem('accessToken', token);
          sessionStorage.setItem('counsellorName', t.name || '');
          sessionStorage.setItem('henleyClientId', t.henleyClientId || '');
          window.clientId = t.clientId || null;
          window.henleyClientId = t.henleyClientId || null;
          selectedCounsellor = t.name || '';
          
          console.log('üíæ Stored in sessionStorage:');
          console.log('  - accessToken:', sessionStorage.getItem('accessToken'));
          console.log('  - counsellorName:', sessionStorage.getItem('counsellorName'));
          console.log('  - selectedCounsellor global:', selectedCounsellor);
          console.log('  - window.clientId:', window.clientId);
          
          return true;
        } else {
          console.log('‚ö†Ô∏è Token invalid or inactive');
          console.log('  - Token data exists?', !!t);
          console.log('  - Token active?', t?.active);
        }
        return false;
      } catch (e) {
        console.error('üö® Token validation error:', e);
        console.error('  - Error message:', e.message);
        console.error('  - Stack:', e.stack);
        return false;
      }
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 4.2: URL PARAMETER PARSING -->
<!-- ================================ -->
  <script>
    // FIXED: Process valid session function WITH DEBUGGING
    function processValidSession(params) {
      console.log('üéØ processValidSession called with params:', Object.fromEntries(params));
      
      const view = params.get('view');
      const date = params.get('date');
      const bookingId = params.get('booking');
      const room = params.get('room');
      const time = params.get('time');
      const modify = params.get('modify');

      console.log('üìã Extracted params:');
      console.log('  - view:', view);
      console.log('  - date:', date);
      console.log('  - modify:', modify);

      if (view === 'day' || view === 'week') {
        currentView = view;
        console.log('  - Set currentView to:', currentView);
      }

      if (date) {
        currentDate = date;
        const dateEl = document.getElementById('dateSelector');
        if (dateEl) {
          dateEl.value = currentDate;
          console.log('  - Set date selector to:', currentDate);
        }
        const d = new Date(date + 'T12:00:00');
        currentWeekStart = getWeekStartDate(d);
        console.log('  - Set week start to:', formatDate(currentWeekStart));
      }

      if (modify === 'true' && bookingId && room && date && time) {
        window.bookingToModify = {
          bookingId,
          room: decodeURIComponent(room),
          date,
          time: decodeURIComponent(time)
        };
        console.log('  - Set booking to modify:', window.bookingToModify);
      }

      console.log('üöÄ Calling initializeWithFullAccess...');
      // Initialize with full access when token is valid
      initializeWithFullAccess();
    }

    // Parse non-token parameters
    function parseNonTokenParams(params) {
      const view = params.get('view');
      const counsellor = params.get('counsellor');
      const clientName = params.get('name');
      const clientId = params.get('clientId');
      const date = params.get('date');
      const bookingId = params.get('booking');
      const room = params.get('room');
      const time = params.get('time');
      const modify = params.get('modify');

      if (view === 'day' || view === 'week') currentView = view;

      if (clientId && clientName) {
        selectedCounsellor = decodeURIComponent(clientName);
        window.clientId = clientId;
      } else if (counsellor) {
        selectedCounsellor = decodeURIComponent(counsellor);
        window.clientId = null;
      } else {
        // last resort: if a previous token set the name, reuse it for rendering
        const storedName = sessionStorage.getItem('counsellorName');
        if (storedName) selectedCounsellor = storedName;
      }

      if (date) {
        currentDate = date;
        const dateEl = document.getElementById('dateSelector');
        if (dateEl) dateEl.value = currentDate;
        const d = new Date(date + 'T12:00:00');
        currentWeekStart = getWeekStartDate(d);
      }

      if (modify === 'true' && bookingId && room && date && time) {
        window.bookingToModify = {
          bookingId,
          room: decodeURIComponent(room),
          date,
          time: decodeURIComponent(time)
        };
      }

      // Initialize with read-only access when no token
      initializeWithReadOnlyAccess();
    }

    // FIXED: Parse URL parameters - token-first and async
    function parseURLParams() {
      const params = new URLSearchParams(window.location.search);
      const tokenFromURL = params.get('token');
      const tokenFromSession = sessionStorage.getItem('accessToken');

      if (tokenFromURL) {
        validateAccessToken(tokenFromURL).then(ok => {
          if (ok) {
            processValidSession(params);
            updateURL(); // ensures token stays in URL
          } else {
            sessionStorage.removeItem('accessToken');
            sessionStorage.removeItem('counsellorName');
            // fall back to non-token params below
            parseNonTokenParams(params);
          }
        });
      } else if (tokenFromSession) {
        validateAccessToken(tokenFromSession).then(ok => {
          if (ok) {
            processValidSession(params);
            updateURL();
          } else {
            sessionStorage.removeItem('accessToken');
            sessionStorage.removeItem('counsellorName');
            parseNonTokenParams(params);
          }
        });
      } else {
        parseNonTokenParams(params);
      }
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 4.3: ACCESS LEVEL INITIALIZATION -->
<!-- ================================ -->
  <script>
 // Initialize with full access
    function initializeWithFullAccess() {
      console.log('Initializing with full access');
      
      // Set up view and controls
      updateViewButtons();
      updateControlsVisibility();
      
      // Load room config FIRST, then create grid and load data
      loadRoomConfig().then(() => {
        const grid = document.getElementById('calendarGrid');
        if (grid) {
          grid.className = `calendar-grid ${currentView}-view`;
          createCalendarGrid();
        }
        initializeData();
      });
      
      // Enable form submission
      const changeForm = document.getElementById('bookingChangeForm');
      if (changeForm) {
        changeForm.addEventListener('submit', handleFormSubmit);
      }
      
      // Set up date selector with token preservation
      document.getElementById('dateSelector').addEventListener('change', function() {
        currentDate = this.value;
        populateCalendar();
        updateURL(); // This will preserve the token
      });
      
      // Handle auto-fill from URL
      if (window.bookingToModify) {
        setTimeout(() => {
          prefillForm(
            window.bookingToModify.bookingId,
            window.bookingToModify.room,
            window.bookingToModify.date,
            window.bookingToModify.time
          );
          
          const formContainer = document.querySelector('.form-container');
          if (formContainer) {
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 500);
      }
    }   
    
    // Initialize with read-only access
    function initializeWithReadOnlyAccess() {
      console.log('Initializing with read-only access');
      
      // Set up view and controls
      updateViewButtons();
      updateControlsVisibility();
      
      const grid = document.getElementById('calendarGrid');
      if (grid) {
        grid.className = `calendar-grid ${currentView}-view`;
        createCalendarGrid();
      }
      
// Load room config first, then booking data
loadRoomConfig().then(() => {
  initializeData();
});
      
      // Set up date selector (still allow navigation)
      document.getElementById('dateSelector').addEventListener('change', function() {
        currentDate = this.value;
        populateCalendar();
        updateURL();
      });
      
      // Disable clicking on bookings
      document.addEventListener('click', function(e) {
        if (e.target.closest('.grid-cell.booked')) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);
    }
    
    // Handle form submit with token
    function handleFormSubmit(e) {
      e.preventDefault();
      
      const token = sessionStorage.getItem('accessToken');
      if (!token) {
        alert('Session expired. Please use your access link to continue.');
        return;
      }
      
      const changeData = {
        originalBookingCode: document.getElementById('bookingCodeInput').value,
        originalRoom: document.getElementById('currentRoomInput').value,
        originalDate: document.getElementById('currentDateInput').value,
        originalTime: document.getElementById('currentTimeInput').value,
        newRoom: document.getElementById('newRoomInput').value,
        newDate: document.getElementById('newDateInput').value,
        newTime: document.getElementById('newTimeInput').value,
        counsellorName: selectedCounsellor,
        accessToken: token
      };
      
      // Booking change validation
      if (!changeData.newRoom && !changeData.newDate && !changeData.newTime) {
        alert('Please specify what changes you would like to make.');
        return;
      }
      
      if (isBookingWithin24Hours(changeData.originalDate, changeData.originalTime)) {
        alert('This booking is within 24 hours and cannot be modified online. Please contact the centre directly.');
        return;
      }
      
      if (changeData.newRoom) {
        const originalLocationId = getLocationIdFromRoom(changeData.originalRoom);
        const requestedLocationId = getLocationIdFromRoom(changeData.newRoom);
        
        if (originalLocationId !== requestedLocationId) {
          const originalLocation = originalLocationId === '1' ? 'Buckhurst Hill' : 'Henley';
          const requestedLocation = requestedLocationId === '1' ? 'Buckhurst Hill' : 'Henley';
          
          alert(`Cannot change locations. Your current booking is in ${originalLocation}, but you selected a room in ${requestedLocation}. Please choose a room in the same location.`);
          return;
        }
      }
      
      if (!changeData.counsellorName) {
        alert('Please select a counsellor first.');
        return;
      }
      
      submitBookingChange(changeData);
    }
    
    // Show access denied
    function showAccessDenied() {
      document.body.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Arial;">
          <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; max-width: 500px;">
            <h2 style="color: #dc3545;">Access Denied</h2>
            <p>Invalid or expired access token.</p>
            <p>Please use the link provided in your weekly email.</p>
            <hr style="margin: 20px 0;">
            <p style="font-size: 14px; color: #666;">If you believe this is an error, please contact the Cherry Tree Centre.</p>
          </div>
        </div>
      `;
    }
    
    // Show limited access
    function showLimitedAccess() {
      // Allow viewing the calendar but not modifying
      const formContainer = document.querySelector('.form-container');
      if (formContainer) {
        formContainer.innerHTML = `
          <div style="padding: 20px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
            <h3 style="color: #856404;">Limited Access</h3>
            <p>You can view the booking calendar, but you need a valid access token to make changes.</p>
            <p style="margin-top: 15px;">To modify bookings, please use the personal link sent to your email.</p>
            <hr style="margin: 20px 0; border-color: #ffeaa7;">
            <p style="font-size: 14px;">If you are a therapist and don't have your access link, please contact the centre administrator.</p>
          </div>
        `;
      }
      
      // Hide modification buttons
      const cancelBtn = document.getElementById('cancelBookingBtn');
      const submitBtn = document.getElementById('submitChangeBtn');
      const holdingBtn = document.getElementById('selectHoldingBtn');
      
      if (cancelBtn) cancelBtn.style.display = 'none';
      if (submitBtn) submitBtn.style.display = 'none';
      if (holdingBtn) holdingBtn.style.display = 'none';
      
      // Still initialize the calendar for viewing
      initializeWithReadOnlyAccess();
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 4.4: ROOM & DATE UTILITIES -->
<!-- ================================ -->
  <script>
    // Populate room dropdown based on current booking's location - ADDED ROOM 5
    function populateRoomDropdown(currentRoom) {
      const newRoomInput = document.getElementById('newRoomInput');
      const roomLabel = document.getElementById('roomChangeLabel');
      if (!newRoomInput) return;
      
      // For holding room bookings, show all rooms
      if (currentRoom === 'Holding Room') {
        newRoomInput.innerHTML = '<option value="">Select a room (required)</option>';
        
        // Add all rooms from both locations
        ['Room 1', 'Room 2', 'Room 4', 'Room 5', 'Room 6', 'Room 7', 'Online'].forEach(roomName => {
          const option = document.createElement('option');
          option.value = roomName;
          option.textContent = roomName;
          newRoomInput.appendChild(option);
        });
        
        if (roomLabel) {
          roomLabel.textContent = 'Select Room (required):';
        }
        return;
      }
      
      // Normal booking - location-based restrictions
      const currentLocationId = getLocationIdFromRoom(currentRoom);
      const availableRooms = getRoomsForLocation(currentLocationId);
      
      newRoomInput.innerHTML = '<option value="">No change</option>';
      
      availableRooms.forEach(roomName => {
        if (roomName !== currentRoom) {
          const option = document.createElement('option');
          option.value = roomName;
          option.textContent = roomName;
          newRoomInput.appendChild(option);
        }
      });
      
      const locationName = currentLocationId === '1' ? 'Buckhurst Hill' : 'Henley';
      if (roomLabel) {
        roomLabel.textContent = `New Room (if changing) - ${locationName} only:`;
      }
    }
    
    // Convert room display name to underscore format for webhook
    function convertRoomNameToUnderscore(roomName) {
      if (roomName && roomName.startsWith('Room ')) {
        return roomName.replace('Room ', 'Room_');
      }
      return roomName;
    }
    
    // Get week start date (Monday)
    function getWeekStartDate(date) {
      const result = new Date(date);
      const day = result.getDay();
      
      let daysToSubtract;
      if (day === 0) {
        daysToSubtract = 6;
      } else {
        daysToSubtract = day - 1;
      }
      
      result.setDate(result.getDate() - daysToSubtract);
      result.setHours(0, 0, 0, 0);
      
      return result;
    }
    
    // Format date as YYYY-MM-DD
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // Get room display name from booking data - ADDED ROOM 5
    function getRoomDisplayName(booking) {
      if (booking.room === 'Room_1' || booking.room === '1') return 'Room 1';
      if (booking.room === 'Room_2' || booking.room === '2') return 'Room 2';
      if (booking.room === 'Room_4' || booking.room === '4') return 'Room 4';
      if (booking.room === 'Room_5' || booking.room === '5') return 'Room 5';
      if (booking.room === 'Room_6' || booking.room === '6') return 'Room 6';
      if (booking.room === 'Room_7' || booking.room === '7') return 'Room 7';
      if (booking.room === 'Henley_Holding_Room' || booking.room === '18') return 'Holding Room';
      if (booking.location && booking.location.toLowerCase().includes('online')) return 'Online';
      return booking.room || 'Unknown';
    }
    
    // Get room mapping for CSS classes - UPDATED FOR CAR PARK
function getRoomMapping(booking) {
  let roomNumber = null;
  let roomClass = '';
  
  // Try to find room in enabled rooms config (uses window.getRoomKey from room-config.js)
  const roomKey = typeof window.getRoomKey === 'function' ? window.getRoomKey(booking) : null;
  
  if (roomKey) {
    // Match the cell ID format used in createDayGrid
    if (roomKey.startsWith('Room_')) {
      roomNumber = roomKey.replace('Room_', ''); // "Room_6" -> "6"
    } else if (roomKey === 'Car_Park') {
      roomNumber = 'car-park';
    } else if (roomKey === 'Online') {
      roomNumber = 'online';
    } else {
      roomNumber = roomKey.toLowerCase().replace('_', '-');
    }
    roomClass = roomKey.toLowerCase().replace('_', '-');
    return { roomNumber, roomClass };
  }
  
  // Fallback: handle Car Park directly if getRoomKey failed (missing return bug in room-config.js)
  if (booking.room && (booking.room.toLowerCase() === 'car park' || booking.room.toLowerCase() === 'car_park')) {
    return { roomNumber: 'car-park', roomClass: 'car-park' };
  }
  
  // Fallback for legacy room data
  if (booking.room === 'Room_1' || booking.room === '1') {
    roomNumber = '1'; roomClass = 'room-1';
  } else if (booking.room === 'Room_2' || booking.room === '2') {
    roomNumber = '2'; roomClass = 'room-2';
  } else if (booking.room === 'Room_4' || booking.room === '4') {
    roomNumber = '4'; roomClass = 'room-4';
  } else if (booking.room === 'Room_5' || booking.room === '5') {
    roomNumber = '5'; roomClass = 'room-5';
  } else if (booking.room === 'Room_6' || booking.room === '6') {
    roomNumber = '6'; roomClass = 'room-6';
  } else if (booking.room === 'Room_7' || booking.room === '7') {
    roomNumber = '7'; roomClass = 'room-7';
  } else if (booking.location && booking.location.toLowerCase().includes('online')) {
    roomNumber = 'online'; roomClass = 'online';
  }
  
  return { roomNumber, roomClass };
}
  </script>
  
<!-- ================================ -->
<!-- SECTION 5: FORM PREFILL & CLEARING -->
<!-- ================================ -->
  <script>
    // Prefill the booking form with selected booking details
    function prefillForm(bookingCode, room, date, time) {
      // Show form elements
      document.getElementById('cancelButtonSection').classList.remove('hidden');
      document.getElementById('formDivider').classList.remove('hidden');
      document.getElementById('changeRequestHeader').classList.remove('hidden');
      
      // Update displays
      const roomDisplay = document.getElementById('currentRoomDisplay');
      const dateDisplay = document.getElementById('currentDateDisplay');
      const timeDisplay = document.getElementById('currentTimeDisplay');
      
      const bookingCodeInput = document.getElementById('bookingCodeInput');
      const currentRoomInput = document.getElementById('currentRoomInput');
      const currentDateInput = document.getElementById('currentDateInput');
      const currentTimeInput = document.getElementById('currentTimeInput');
      const counsellorNameInput = document.getElementById('counsellorNameInput');
      
      const pastNotice = document.getElementById('pastBookingNotice');
      const cancelBtn = document.getElementById('cancelBookingBtn');
      const submitBtn = document.getElementById('submitChangeBtn');
      const newRoomInput = document.getElementById('newRoomInput');
      const newDateInput = document.getElementById('newDateInput');
      const newTimeInput = document.getElementById('newTimeInput');
      
      if (!roomDisplay || !dateDisplay || !timeDisplay) {
        console.warn('Display elements not found, cannot pre-fill form');
        return;
      }
      
      roomDisplay.textContent = room || '';
      dateDisplay.textContent = date || '';
      timeDisplay.textContent = time || '';
      
      if (bookingCodeInput) bookingCodeInput.value = bookingCode || '';
      if (currentRoomInput) currentRoomInput.value = room || '';
      if (currentDateInput) currentDateInput.value = date || '';
      if (currentTimeInput) currentTimeInput.value = time || '';
      
      if (selectedCounsellor && counsellorNameInput) {
        counsellorNameInput.value = selectedCounsellor;
      } else if (counsellorNameInput) {
        counsellorNameInput.value = 'Please select counsellor from dropdown above';
      }
      
      // Check 24-hour restriction
      const isWithin24Hours = isBookingWithin24Hours(date, time);
      
      if (isWithin24Hours) {
        if (pastNotice) pastNotice.classList.remove('hidden');
        if (cancelBtn) cancelBtn.disabled = true;
        if (submitBtn) submitBtn.disabled = true;
        if (newRoomInput) newRoomInput.disabled = true;
        if (newDateInput) newDateInput.disabled = true;
        if (newTimeInput) newTimeInput.disabled = true;
      } else {
        if (pastNotice) pastNotice.classList.add('hidden');
        if (cancelBtn) cancelBtn.disabled = false;
        if (submitBtn) submitBtn.disabled = false;
        if (newRoomInput) newRoomInput.disabled = false;
        if (newDateInput) newDateInput.disabled = false;
        if (newTimeInput) newTimeInput.disabled = false;
        
        populateRoomDropdown(room);
      }
      
      // Make fields optional for normal bookings
      if (newRoomInput) newRoomInput.required = false;
      if (newDateInput) newDateInput.required = false;
      if (newTimeInput) newTimeInput.required = false;
      
      // Clear any previous new values
      if (newRoomInput) newRoomInput.value = '';
      if (newDateInput) newDateInput.value = '';
      if (newTimeInput) newTimeInput.value = '';
      
      // Reset submit button text
      if (submitBtn) submitBtn.textContent = 'Submit Change Request';
      
      console.log('Pre-filled form with:', {
        bookingCode, room, date, time,
        counsellor: selectedCounsellor || 'Not set',
        within24Hours: isWithin24Hours
      });
    }
    
    // Clear the booking form
    function clearBookingForm() {
      const roomDisplay = document.getElementById('currentRoomDisplay');
      const dateDisplay = document.getElementById('currentDateDisplay');
      const timeDisplay = document.getElementById('currentTimeDisplay');
      
      if (roomDisplay) roomDisplay.textContent = '';
      if (dateDisplay) dateDisplay.textContent = '';
      if (timeDisplay) timeDisplay.textContent = '';
      
      const bookingCodeInput = document.getElementById('bookingCodeInput');
      const currentRoomInput = document.getElementById('currentRoomInput');
      const currentDateInput = document.getElementById('currentDateInput');
      const currentTimeInput = document.getElementById('currentTimeInput');
      const counsellorNameInput = document.getElementById('counsellorNameInput');
      const newRoomInput = document.getElementById('newRoomInput');
      const newDateInput = document.getElementById('newDateInput');
      const newTimeInput = document.getElementById('newTimeInput');
      
      if (bookingCodeInput) bookingCodeInput.value = '';
      if (currentRoomInput) currentRoomInput.value = '';
      if (currentDateInput) currentDateInput.value = '';
      if (currentTimeInput) currentTimeInput.value = '';
      if (counsellorNameInput) counsellorNameInput.value = '';
      if (newRoomInput) newRoomInput.value = '';
      if (newDateInput) newDateInput.value = '';
      if (newTimeInput) newTimeInput.value = '';
      
      // Show form elements
      document.getElementById('cancelButtonSection').classList.remove('hidden');
      document.getElementById('formDivider').classList.remove('hidden');
      document.getElementById('changeRequestHeader').classList.remove('hidden');
      
      const cancelBtn = document.getElementById('cancelBookingBtn');
      if (cancelBtn) {
        cancelBtn.disabled = true;
      }
      
      const pastNotice = document.getElementById('pastBookingNotice');
      if (pastNotice) {
        pastNotice.classList.add('hidden');
      }
      
      const submitBtn = document.getElementById('submitChangeBtn');
      if (submitBtn) submitBtn.textContent = 'Submit Change Request';
    }
  </script>

  
<!-- ================================ -->
<!-- SECTION 5.1: PAYMENT RETURN HANDLING -->
<!-- ================================ -->
  <script>
function handlePaymentReturn() {
  const params = new URLSearchParams(window.location.search);
  const paymentStatus = params.get('payment');
  const returnDate = params.get('date');
  
  if (paymentStatus === 'success') {
    // Show success toast
    showPaymentToast('√¢≈ì‚Ä¶ Payment successful! Your booking has been confirmed.', 'success');
    
    // Jump to the booking date if provided
    if (returnDate) {
      currentDate = returnDate;
      const dateSelector = document.getElementById('dateSelector');
      if (dateSelector) dateSelector.value = returnDate;
    }
    
    // Clean up URL (preserve token if present)
    const token = params.get('token');
    const cleanUrl = window.location.pathname + (token ? '?token=' + token : '');
    window.history.replaceState({}, '', cleanUrl);
    
    // Refresh data to show new booking
    setTimeout(() => {
      if (typeof refreshData === 'function') refreshData();
    }, 1500);
    
  } else if (paymentStatus === 'cancelled') {
    // Show cancelled toast
    showPaymentToast('‚ö†Ô∏è Payment cancelled. No booking was created.', 'warning');
    
    // Clean up URL
    const token = params.get('token');
    const cleanUrl = window.location.pathname + (token ? '?token=' + token : '');
    window.history.replaceState({}, '', cleanUrl);
  }
}

function showPaymentToast(message, type) {
  // Remove existing toast if any
  const existingToast = document.getElementById('paymentToast');
  if (existingToast) existingToast.remove();
  
  const toast = document.createElement('div');
  toast.id = 'paymentToast';
  toast.className = `payment-toast ${type}`;
  toast.innerHTML = `
    <span>${message}</span>
    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:inherit;cursor:pointer;font-size:20px;margin-left:15px;line-height:1;">√ó</button>
  `;
  document.body.appendChild(toast);
  
  // Auto-remove after 8 seconds
  setTimeout(() => {
    if (toast.parentElement) toast.remove();
  }, 8000);
}
  </script>
  
 <!-- SECTIONS 5.1.1 & 5.1.2 moved to js/account.js -->
  
<!-- ================================ -->
<!-- SECTION 5.2: BOOKING CANCELLATION -->
<!-- ================================ -->
  <script>
    // Handle booking cancellation
    async function cancelBooking() {
      const bookingCode = document.getElementById('bookingCodeInput').value;
      const room = document.getElementById('currentRoomInput').value;
      const date = document.getElementById('currentDateInput').value;
      const time = document.getElementById('currentTimeInput').value;
      const counsellorName = selectedCounsellor;
      
      if (!bookingCode || !counsellorName) {
        alert('Please select a booking first by clicking on it in the calendar.');
        return;
      }
      
      if (isBookingWithin24Hours(date, time)) {
        alert('This booking is within 24 hours and cannot be cancelled online. Please contact the centre directly.');
        return;
      }
      
      const booking = bookingData.find(b => 
        (b.bookingId === bookingCode || b.code === bookingCode) &&
        b.date === date &&
        b.start === time
      );
      
      const isPaidBooking = booking && booking.isPaid;
      const bookingId = booking?.bookingId || bookingCode;
      
      if (!confirm(`Are you sure you want to cancel this appointment?\n\nDate: ${date}\nTime: ${time}\nRoom: ${room}\n\nThis action cannot be undone.`)) {
        return;
      }
      
      const cancelStatusDiv = document.getElementById('cancelStatus');
      
      try {
        cancelStatusDiv.style.display = 'block';
        cancelStatusDiv.style.background = '#fff3cd';
        cancelStatusDiv.style.color = '#856404';
        cancelStatusDiv.style.border = '1px solid #ffeaa7';
        cancelStatusDiv.textContent = 'Processing cancellation...';
        
        let counsellorId = window.clientId;
        
        if (!counsellorId) {
          counsellorId = await lookupCounsellorId(counsellorName);
          if (!counsellorId) {
            throw new Error(`Counsellor "${counsellorName}" not found. Please contact support.`);
          }
        }
        
        let roomForWebhook = room;
        if (room && room.startsWith('Room ')) {
          roomForWebhook = room.replace('Room ', 'Room_');
        }
        
        // All cancellations now use cancel action (no more holding room)
        const payload = {
          timestamp: new Date().toISOString(),
          action: 'cancel',
          client_id: window.clientId,
          counsellor_id: window.henleyClientId,
          booking_code: bookingId,
          original_datetime: `${date}T${time}:00`,
          original_room: roomForWebhook,
          service_id: booking?.serviceId || getServiceIdForRoom(room),
          comments: booking ? (booking.comments || '') : '',
          is_paid: isPaidBooking ? 'True' : 'No',
          payment: isPaidBooking ? {
            paymentId: booking.paymentId || null,
            paymentAmount: booking.paymentAmount || booking.price || booking.stripePaid || 0
          } : null
        };
        
        cancelStatusDiv.textContent = 'Sending cancellation request...';
        const CANCEL_WEBHOOK_URL = 'https://hook.eu2.make.com/p754q5eks857boisu6m3unr6qer6be4t';
        
        const response = await fetch(CANCEL_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          throw new Error(`Cancellation failed: ${response.status} - ${await response.text()}`);
        }
        
        // Wait for Firebase to confirm the cancellation
        cancelStatusDiv.textContent = 'Confirming cancellation...';
        
        const confirmed = await waitForCancellationConfirmation(bookingId, 15000);
        
        if (confirmed) {
          cancelStatusDiv.style.background = '#d4edda';
          cancelStatusDiv.style.color = '#155724';
          cancelStatusDiv.style.border = '1px solid #c3e6cb';
          cancelStatusDiv.textContent = 'Appointment cancelled successfully!';
        } else {
          cancelStatusDiv.style.background = '#fff3cd';
          cancelStatusDiv.style.color = '#856404';
          cancelStatusDiv.style.border = '1px solid #ffeaa7';
          cancelStatusDiv.textContent = 'Cancellation request sent. Please refresh to confirm.';
        }
        
        clearBookingForm();
        
        setTimeout(() => {
          refreshData();
          cancelStatusDiv.style.display = 'none';
        }, 3000);
        
      } catch (error) {
        console.error('Cancellation error:', error);
        cancelStatusDiv.style.background = '#f8d7da';
        cancelStatusDiv.style.color = '#721c24';
        cancelStatusDiv.style.border = '1px solid #f5c6cb';
        cancelStatusDiv.textContent = `Error: ${error.message}`;
      }
    }
    
    // Wait for Firebase to confirm booking is cancelled
    async function waitForCancellationConfirmation(bookingId, timeoutMs) {
      const startTime = Date.now();
      const pollInterval = 1000; // Check every second
      
      while (Date.now() - startTime < timeoutMs) {
        try {
          const snapshot = await database.ref(`bookings/${bookingId}/status`).once('value');
          const status = snapshot.val();
          
          if (status === 'cancelled' || status === 'cancel') {
            return true;
          }
        } catch (e) {
          console.warn('Error checking cancellation status:', e);
        }
        
        // Wait before next poll
        await new Promise(resolve => setTimeout(resolve, pollInterval));
      }
      
      return false; // Timeout
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 5.3: BOOKING CHANGE SUBMISSION -->
<!-- ================================ -->
  <script>
    // Submit booking change request - UPDATED ROOM MAPPING WITH ROOM 5
    async function submitBookingChange(changeData) {
      const statusDiv = document.getElementById('submitStatus');
      
      try {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#fff3cd';
        statusDiv.style.color = '#856404';
        statusDiv.style.border = '1px solid #ffeaa7';
        statusDiv.textContent = 'Submitting change request...';
        
        let counsellorId = window.clientId;
        
        if (!counsellorId) {
          counsellorId = await lookupCounsellorId(changeData.counsellorName);
          if (!counsellorId) {
            throw new Error(`Counsellor "${changeData.counsellorName}" not found. Please contact support.`);
          }
        }
        
        // FIXED: Find booking and use bookingId directly
        const booking = bookingData.find(b => 
          (b.bookingId === changeData.originalBookingCode || b.code === changeData.originalBookingCode)
        );
        
        const originalRoomUnderscore = convertRoomNameToUnderscore(changeData.originalRoom);
        const newRoomUnderscore = changeData.newRoom ? convertRoomNameToUnderscore(changeData.newRoom) : originalRoomUnderscore;
        
      // Get room IDs from Firebase room_config
       function getRoomIdFromConfig(roomName) {
       const roomKey = roomName.replace(' ', '_');
       if (window.roomConfig && window.roomConfig[roomKey]) {
        return window.roomConfig[roomKey].henleyRoomId;
   }
        console.warn('Room not found in config:', roomName);
         return null;
  }

const originalRoomId = getRoomIdFromConfig(originalRoomUnderscore);
const requestedRoomId = getRoomIdFromConfig(newRoomUnderscore);

if (!requestedRoomId) {
  throw new Error(`Room "${newRoomUnderscore}" not found in room configuration`);
}
        
        if (!requestedRoomId) {
          throw new Error(`Room mapping failed for "${newRoomUnderscore}"`);
        }
        
        const originalLocationId = getLocationIdFromRoom(originalRoomUnderscore);
        const requestedLocationId = getLocationIdFromRoom(newRoomUnderscore);
        
        const webhookPayload = {
          timestamp: new Date().toISOString(),
          action: 'modify',
          client_id: window.clientId,
          counsellor_id: window.henleyClientId,
          original_booking_code: booking ? booking.bookingId : changeData.originalBookingCode,  // FIXED: Use bookingId from booking object
          original_room: originalRoomUnderscore,
          original_room_id: originalRoomId,
          original_location_id: originalLocationId,
          original_datetime: `${changeData.originalDate}T${changeData.originalTime}:00`,
          requested_room: newRoomUnderscore,
          requested_room_id: requestedRoomId,
          requested_location_id: requestedLocationId,
          requested_datetime: formatDateTimeForSimplybookMe(
            changeData.newDate || changeData.originalDate,
            changeData.newTime || changeData.originalTime
          ),
          service_id: booking?.serviceId || getServiceIdForRoom(changeData.newRoom || changeData.originalRoom),
          comments: booking ? (booking.comments || '') : '',
          is_paid: booking ? (booking.isPaid ? 'True' : 'No') : 'No'
        };
        
        console.log('Webhook payload:', webhookPayload);
        
        statusDiv.textContent = 'Sending to booking system...';
        const MAKE_WEBHOOK_URL = 'https://hook.eu2.make.com/p754q5eks857boisu6m3unr6qer6be4t';
        
        const response = await fetch(MAKE_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(webhookPayload)
        });
        
        if (!response.ok) {
          throw new Error(`Booking system error: ${response.status} - ${await response.text()}`);
        }
        
        console.log('Make webhook success');
        
        statusDiv.textContent = 'Logging change request...';
        await logChangeToGoogleSheets(changeData, webhookPayload);
        
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
        statusDiv.textContent = 'Change request submitted successfully!';
        
        clearBookingForm();
        
        setTimeout(() => {
          statusDiv.style.display = 'none';
          refreshData();
        }, 7000);
        
      } catch (error) {
        console.error('Submission error:', error);
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
        statusDiv.textContent = `Error: ${error.message}`;
      }
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 5.4: COUNSELLOR & LOGGING FUNCTIONS -->
<!-- ================================ -->
  <script>
    // Fallback counsellor ID lookup
    async function lookupCounsellorId(counsellorName) {
      try {
        const booking = bookingData.find(b => b.client === counsellorName && b.clientId);
        if (booking && booking.clientId) {
          console.log(`Found counsellor ID ${booking.clientId} for ${counsellorName} in booking data`);
          return booking.clientId;
        }
        
        const COUNSELLOR_MAPPING = {
          'Barry Redman': '6',
        };
        
        return COUNSELLOR_MAPPING[counsellorName] || null;
        
      } catch (error) {
        console.error('Counsellor lookup error:', error);
        return null;
      }
    }
    
    // Log change to Google Sheets
    async function logChangeToGoogleSheets(changeData, webhookPayload) {
      try {
        const CHANGE_REQUESTS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVIQAryAHaD9HfEqAvaxXDo-nd1BSN664E4Kyg1tVWgmOsTfG6VS7JYgHohqN7HQiz/exec';
        
        const formData = new FormData();
        formData.append('action', 'submitBookingChange');
        formData.append('timestamp', webhookPayload.timestamp);
        formData.append('counsellorName', changeData.counsellorName);
        formData.append('originalBookingCode', changeData.originalBookingCode);
        formData.append('originalRoom', changeData.originalRoom);
        formData.append('originalDate', changeData.originalDate);
        formData.append('originalTime', changeData.originalTime);
        
        const requestedDate = changeData.newDate || changeData.originalDate;
        const requestedTime = changeData.newTime || changeData.originalTime;
        const requestedDateTime = formatDateTimeForSimplybookMe(requestedDate, requestedTime);
        const requestedRoom = changeData.newRoom || changeData.originalRoom;
        
        formData.append('requestedDateTime', requestedDateTime);
        formData.append('requestedRoom', requestedRoom);
        formData.append('webhookSent', 'Yes');
        formData.append('submissionMethod', 'Direct from HTML');
        
        const response = await fetch(CHANGE_REQUESTS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          console.log('Successfully logged to Google Sheets');
        } else {
          console.warn('Failed to log to Google Sheets, but webhook was sent');
        }
        
      } catch (error) {
        console.warn('Google Sheets logging failed:', error);
      }
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 6: PRICING CONFIGURATION -->
<!-- ================================ -->
  <script>
    // Load pricing configuration from Firebase
    async function loadPricingConfig() {
      try {
        const snapshot = await database.ref('pricing_config').once('value');
        pricingConfig = snapshot.val();
        
        if (pricingConfig) {
          console.log('Loaded pricing config from Firebase:', pricingConfig);
        } else {
          console.warn('No pricing config found in Firebase, using defaults');
          // Default pricing configuration
          pricingConfig = {
            rates: {
              "A": { amount: 1300, label: "Standard" },
              "B": { amount: 1400, label: "Evening" },
              "C": { amount: 800, label: "Sunday Special" }
            },
            locations: {
              "1": {
                name: "Buckhurst Hill",
                rules: [
                  { days: [0, 6], startHour: 8, endHour: 21, rate: "A" },
                  { days: [1, 2, 3, 4, 5], startHour: 8, endHour: 17, rate: "A" },
                  { days: [1, 2, 3, 4, 5], startHour: 17, endHour: 21, rate: "B" }
                ]
              },
              "2": {
                name: "Henley",
                rules: [
                  { days: [0], startHour: 8, endHour: 21, rate: "C" },
                  { days: [1, 2, 3, 4, 5, 6], startHour: 8, endHour: 21, rate: "A" }
                ]
              }
            },
            durations: [
              { minutes: 60, label: "1 Hour", multiplier: 1 },
              { minutes: 75, label: "1 Hour 15 Mins", multiplier: 1 },
              { minutes: 240, label: "4 Hours", multiplier: 4 }
            ],
            discounts: {}
          };
        }
      } catch (error) {
        console.error('Error loading pricing config:', error);
        // Use default on error as well
        pricingConfig = {
          rates: {
            "A": { amount: 1300, label: "Standard" }
          },
          locations: {
            "1": {
              name: "Buckhurst Hill",
              rules: [{ days: [0,1,2,3,4,5,6], startHour: 8, endHour: 21, rate: "A" }]
            },
            "2": {
              name: "Henley",
              rules: [{ days: [0,1,2,3,4,5,6], startHour: 8, endHour: 21, rate: "A" }]
            }
          },
          durations: [{ minutes: 60, label: "1 Hour", multiplier: 1 }],
          discounts: {}
        };
      }
    }
    
  // Calculate price for a booking
    function calculateBookingPrice(locationId, date, hour, room) {
      if (!pricingConfig) {
        console.warn('calculateBookingPrice: pricingConfig is null');
        return { amount: 0, breakdown: 'Pricing not loaded', rate: null };
      }
      
      const bookingDate = new Date(date + 'T12:00:00');
      const dayOfWeek = bookingDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
      
      const location = pricingConfig.locations[locationId];
      if (!location) {
        console.warn(`calculateBookingPrice: Location ${locationId} not found in config`);
        return { amount: 0, breakdown: 'Location not found', rate: null };
      }
      
      // Normalize room name for matching (e.g., "Car Park" ‚Üí "Car_Park")
      const roomKey = room ? room.replace(' ', '_') : null;
      
      // Find matching rule - check rooms array if present
      let matchedRule = null;
      for (const rule of location.rules) {
        // Check day and hour
        if (!rule.days.includes(dayOfWeek) || hour < rule.startHour || hour >= rule.endHour) {
          continue;
        }
        
        // Check room if rule has rooms array
        if (rule.rooms && rule.rooms.length > 0) {
          // Rule is room-specific - only match if room is in the list
          if (roomKey && rule.rooms.includes(roomKey)) {
            matchedRule = rule;
            break;
          }
          // Room not in this rule's list, continue checking other rules
        } else {
          // Rule has no rooms array - applies to all rooms (but lower priority than room-specific rules)
          if (!matchedRule) {
            matchedRule = rule;
          }
          // Don't break - keep looking for a more specific room rule
        }
      }
      
      if (!matchedRule) {
        console.warn(`calculateBookingPrice: No rule matches day ${dayOfWeek}, hour ${hour}, room ${room} for location ${locationId}`);
        return { amount: 0, breakdown: 'No pricing rule for this time', rate: null };
      }
      
      const rate = pricingConfig.rates[matchedRule.rate];
      if (!rate) {
        console.warn(`calculateBookingPrice: Rate ${matchedRule.rate} not found`);
        return { amount: 0, breakdown: `Rate ${matchedRule.rate} not found`, rate: null };
      }
      
      // For now, always 1 hour (multiplier = 1)
      const price = rate.amount;
      const breakdown = `${rate.label} rate (${matchedRule.rate})`;
      
      return { amount: price, breakdown, rate: matchedRule.rate };
    }
    
    // Get room to location mapping
    function getRoomLocationId(roomName) {
      // Online is Buckhurst Hill (location 1), all others are Henley (location 2)
      if (roomName === 'Online') {
        return '1';
      }
      return '2';
    }
    
    // Get room ID for SimplybookMe
	function getRoomProviderId(roomName) {
      const roomKey = roomName.replace(' ', '_');
      const roomCfg = (window.enabledRooms || []).find(r => r.displayName === roomName || r.key === roomKey);
      return roomCfg?.henleyRoomId || null;
    }

	
  </script>
  

<!-- ================================ -->
<!-- SECTION 6.1: NEW BOOKING MODAL FUNCTIONS -->
<!-- ================================ -->
  <script>
    // Open new booking modal
    function openNewBookingModal(room, date, time) {
      const locationId = getRoomLocationId(room);
      const locationName = locationId === '1' ? 'Buckhurst Hill' : 'Henley';
      const hour = parseInt(time.split(':')[0]);
      const endHour = hour + 1;
      const endTime = `${String(endHour).padStart(2, '0')}:00`;
      
      // Format date for display
      const dateObj = new Date(date + 'T12:00:00');
      const dayName = weekDays[dateObj.getDay()];
      const formattedDate = `${dayName}, ${dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}`;
      
      // Calculate price
      const priceResult = calculateBookingPrice(locationId, date, hour, room);
      
      // Populate modal
      document.getElementById('modalRoom').textContent = room;
      document.getElementById('modalDate').textContent = formattedDate;
      document.getElementById('modalTime').textContent = `${time} - ${endTime}`;
      document.getElementById('modalDuration').textContent = '1 Hour';
      document.getElementById('modalLocation').textContent = locationName;
      
      // Set hidden fields
      document.getElementById('newBookingRoom').value = room;
      document.getElementById('newBookingRoomId').value = getRoomProviderId(room);
      document.getElementById('newBookingDate').value = date;
      document.getElementById('newBookingTime').value = time;
      document.getElementById('newBookingEndTime').value = endTime;
      document.getElementById('newBookingLocationId').value = locationId;
      document.getElementById('newBookingPrice').value = priceResult.amount;
      
      // Set serviceId: Car Park = 9, all other rooms = 1
      const serviceId = (room === 'Car Park' || room === 'Car_Park') ? '9' : '1';
      document.getElementById('newBookingServiceId').value = serviceId;
      
      // Update price display
      const priceDisplay = document.getElementById('priceDisplay');
      const priceAmount = document.getElementById('priceAmount');
      const priceBreakdown = document.getElementById('priceBreakdown');
      
      if (priceResult.amount > 0) {
        priceDisplay.classList.remove('no-rate');
        priceAmount.textContent = `¬£${(priceResult.amount / 100).toFixed(2)}`;
        priceBreakdown.textContent = priceResult.breakdown;
        document.getElementById('confirmBookingBtn').disabled = false;
      } else {
        priceDisplay.classList.add('no-rate');
        priceAmount.textContent = '¬£0.00';
        priceBreakdown.textContent = priceResult.breakdown;
        document.getElementById('confirmBookingBtn').disabled = true;
      }
      
      // Reset status
      document.getElementById('bookingStatus').style.display = 'none';
      

      // Configure comments field based on room type
      const isCarPark = (room === 'Car Park' || room === 'Car_Park');
      const commentsInput = document.getElementById('newBookingComments');
      const commentsLabelText = document.getElementById('commentsLabelText');
      const commentsRequired = document.getElementById('commentsRequired');
      const commentsHint = document.getElementById('commentsHint');
      
      commentsInput.value = ''; // Clear previous value
      
      if (isCarPark) {
        commentsLabelText.textContent = 'Car Registration';
        commentsRequired.style.display = 'inline';
        commentsInput.placeholder = 'Enter car registration number...';
        commentsInput.required = true;
        commentsHint.textContent = 'Required for car park bookings';
        commentsHint.style.color = '#dc3545';
      } else {
        commentsLabelText.textContent = 'Comments';
        commentsRequired.style.display = 'none';
        commentsInput.placeholder = 'Optional comments...';
        commentsInput.required = false;
        commentsHint.textContent = 'Add any notes for this booking';
        commentsHint.style.color = '#666';
      }
      // Show modal
      document.getElementById('newBookingModal').classList.add('active');
    }
    
    // Close new booking modal
    function closeNewBookingModal() {
      document.getElementById('newBookingModal').classList.remove('active');
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 6.2: CONFIRM NEW BOOKING -->
<!-- ================================ -->
  <script>
    // Confirm new booking (with payment choice modal for paid bookings)
    async function confirmNewBooking() {
      const room = document.getElementById('newBookingRoom').value;
      const roomId = document.getElementById('newBookingRoomId').value;
      const date = document.getElementById('newBookingDate').value;
      const time = document.getElementById('newBookingTime').value;
      const endTime = document.getElementById('newBookingEndTime').value;
      const locationId = document.getElementById('newBookingLocationId').value;
      const price = parseInt(document.getElementById('newBookingPrice').value) || 0;
      const serviceId = document.getElementById('newBookingServiceId').value || '1';
	  const comments = document.getElementById('newBookingComments').value.trim();
      
      const isCarPark = (room === 'Car Park' || room === 'Car_Park');
      if (isCarPark && !comments) {
        alert('Please enter a car registration number for Car Park bookings');
        document.getElementById('newBookingComments').focus();
        return;
      }
      
      const statusDiv = document.getElementById('bookingStatus');
      const confirmBtn = document.getElementById('confirmBookingBtn');
      
      // Webhook URL for FREE bookings only
      const FREE_BOOKING_WEBHOOK_URL = 'https://hook.eu2.make.com/eq57vfwrpkw2rtozjeiy71j88e5sw1kr';
      
      try {
        const counsellorName = selectedCounsellor || sessionStorage.getItem('counsellorName');
        
        // Handle based on price
        if (price === 0) {
          // FREE BOOKING - Send directly to webhook
          statusDiv.className = 'booking-status processing';
          statusDiv.textContent = 'Creating booking...';
          statusDiv.style.display = 'block';
          confirmBtn.disabled = true;
          
          const bookingPayload = {
            action: 'create',
            timestamp: new Date().toISOString(),
            client_id: window.clientId,
            counsellor_name: counsellorName,
            service_id: serviceId,
            provider_id: roomId,
            location_id: locationId,
            room_name: room,
            start_datetime: `${date}T${time}:00`,
            end_datetime: `${date}T${endTime}:00`,
            additional_fields: {
              comments: comments || `Booked via counsellor calendar by ${counsellorName}`
            },
            payment: {
              paymentId: null,
              paymentAmount: 0,
              paymentStatus: 'free',
              paymentMethod: 'none'
            }
          };
          
          console.log('Free booking payload:', bookingPayload);
          
          const response = await fetch(FREE_BOOKING_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookingPayload)
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Webhook failed: ${response.status} - ${errorText}`);
          }
          
          console.log('Webhook response:', response.status);
          
          // Success!
          statusDiv.className = 'booking-status success';
          statusDiv.innerHTML = `
            <strong>√¢≈ì‚Äù Booking Created!</strong><br>
            <small>${room} on ${date} at ${time}<br>
            The calendar will refresh shortly.</small>
          `;
          
          // Close modal and refresh after delay - stay on booking date
          setTimeout(() => {
            closeNewBookingModal();
            
            // Navigate to booking date before refresh
            currentDate = date;
            const dateSelector = document.getElementById('dateSelector');
            if (dateSelector) dateSelector.value = date;
            currentWeekStart = getWeekStartDate(new Date(date + 'T12:00:00'));
            
            refreshData();
          }, 3000);
          
        } else {
          // PAID BOOKING - Show payment choice modal
          // Close the booking modal first
          closeNewBookingModal();
          
          // Format date for display
          const dateObj = new Date(date + 'T00:00:00');
          const formattedDate = dateObj.toLocaleDateString('en-GB', { 
            weekday: 'short', 
            day: 'numeric', 
            month: 'short',
            year: 'numeric'
          });
          
          // Build payment details for the payment choice modal
          const paymentDetails = {
            room: room,
            roomId: roomId,
            date: date,
            time: time,
            endTime: endTime,
            formattedDate: formattedDate,
            locationId: locationId,
            serviceId: serviceId,
            totalAmount: price,
            comments: comments || null
          };
          
          console.log('üí≥ Opening payment choice modal:', paymentDetails);
          
          // Show the payment choice modal (handles credit vs card)
          showPaymentChoiceModal(paymentDetails, false);
        }
        
      } catch (error) {
        console.error('Booking error:', error);
        statusDiv.className = 'booking-status error';
        statusDiv.innerHTML = `<strong>Error</strong><br><small>${error.message}</small>`;
        confirmBtn.disabled = false;
      }
    }
  </script>


<!-- ================================ -->
<!-- SECTION 6.3: SLOT AVAILABILITY CHECKING -->
<!-- ================================ -->
  <script>
    // Check if a time slot is available (supports capacity for Car Park)
    function isSlotAvailable(room, date, time) {
      // Find room config
      const roomKey = room.replace(' ', '_');
      const roomCfg = (window.enabledRooms || []).find(r => r.displayName === room || r.key === roomKey);
      const capacity = roomCfg?.capacity || 1;
      
      // Get all room key variants for matching (including 'Car park' lowercase)
      const roomVariants = [room, roomKey, room.replace('Room ', ''), 'Car_Park', 'Car Park', 'Car park'];
      
      const hour = parseInt(time.split(':')[0]);
      const dayBookings = bookingData.filter(booking => booking.date === date);
      
      // Count bookings for this room/hour
      let bookingCount = 0;
      
      for (const booking of dayBookings) {
        const bookingRoomMatches = roomVariants.some(variant => 
          booking.room === variant || 
          booking.room === roomKey ||
          (booking.location && booking.location.toLowerCase().includes('online') && room === 'Online')
        );
        
        if (bookingRoomMatches) {
          const startHour = parseInt(booking.start.split(':')[0]);
          const endHour = parseInt(booking.end.split(':')[0]);
          
          if (hour >= startHour && hour < endHour) {
            bookingCount++;
          }
        }
      }
      
      return bookingCount < capacity;
    }
    
    // Get current booking count for a room/date/time (for capacity display)
    function getSlotBookingCount(room, date, time) {
      const roomKey = room.replace(' ', '_');
      const roomVariants = [room, roomKey, room.replace('Room ', ''), 'Car_Park', 'Car Park', 'Car park'];
      
      const hour = parseInt(time.split(':')[0]);
      const dayBookings = bookingData.filter(booking => booking.date === date);
      
      let bookingCount = 0;
      
      for (const booking of dayBookings) {
        const bookingRoomMatches = roomVariants.some(variant => 
          booking.room === variant || 
          booking.room === roomKey
        );
        
        if (bookingRoomMatches) {
          const startHour = parseInt(booking.start.split(':')[0]);
          const endHour = parseInt(booking.end.split(':')[0]);
          
          if (hour >= startHour && hour < endHour) {
            bookingCount++;
          }
        }
      }
      
      return bookingCount;
    }
  </script>
  
  
  <!-- ================================ -->
<!-- SECTION 6.4: AVAILABLE SLOT MARKING -->
<!-- ================================ -->
  <script>
    // Mark available slots for new bookings (called from populateDayView)
    function markAvailableSlotsForNewBookings(selectedDate) {
      const hasValidToken = !!sessionStorage.getItem('accessToken');
      if (!hasValidToken) return;
      
      const now = new Date();
      const isPastDate = new Date(selectedDate + 'T23:59:59') < now;
      if (isPastDate) return;
      
      // Use dynamic enabled rooms from config
      (window.enabledRooms || []).forEach((room) => {
        const roomName = room.displayName;
        const capacity = room.capacity || 1;
        const isCarPark = room.key === 'Car_Park';
        
        // Generate cell ID to match createDayGrid format
        let roomId;
        if (room.key.startsWith('Room_')) {
          roomId = room.key.replace('Room_', '');
        } else if (room.key === 'Car_Park') {
          roomId = 'car-park';
        } else if (room.key === 'Online') {
          roomId = 'online';
        } else {
          roomId = room.key.toLowerCase().replace('_', '-');
        }
        
        businessHours.forEach(time => {
          const cellId = `cell-${roomId}-${time}`;
          const cell = document.getElementById(cellId);
          
          if (!cell) return;
          
          // Check if slot is in the past
          const slotDateTime = new Date(`${selectedDate}T${time}:00`);
          if (slotDateTime < now) return;
          
          // For Car Park: check capacity, not just if booked
          if (isCarPark) {
            const currentCount = getSlotBookingCount(roomName, selectedDate, time);
            const hasAvailability = currentCount < capacity;
            
            // Update cell display for Car Park
            if (currentCount > 0) {
              cell.classList.add('car-park-partial');
              cell.innerHTML = `<div class="capacity-display">${currentCount}/${capacity} booked</div>`;
            }
            
            if (hasAvailability) {
              cell.classList.add('available-slot');
              cell.style.cursor = 'pointer';
              cell.title = `Book Car Park at ${time} (${capacity - currentCount} spaces available)`;
              
              cell.addEventListener('click', function(e) {
                openNewBookingModal(roomName, selectedDate, time);
              });
            } else {
              cell.classList.add('at-capacity');
              cell.title = `Car Park full at ${time}`;
            }
          } else {
            // Normal rooms - skip if already booked
            if (cell.classList.contains('booked')) return;
            
            // Make clickable
            cell.classList.add('available-slot');
            cell.style.cursor = 'pointer';
            cell.title = `Book ${roomName} at ${time}`;
            
            cell.addEventListener('click', function(e) {
              if (e.target.closest('.booked')) return;
              openNewBookingModal(roomName, selectedDate, time);
            });
          }
        });
      });
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 7: CALENDAR VIEW SWITCHING -->
<!-- ================================ -->
  <script>
// UPDATED: Switch between day and week views
    function switchView(view) {
      restoreSessionState(); 
      currentView = view;
      
      const buttons = document.querySelectorAll('.view-btn');
      if (buttons.length > 0) {
        buttons.forEach(btn => btn.classList.remove('active'));
        const clickedButton = event ? event.target : document.querySelector(`.view-btn[onclick*="${view}"]`);
        if (clickedButton) clickedButton.classList.add('active');
      }
      
      // FIX: Target the container divs, not the input directly
      const weekControls = document.getElementById('weekControls');
      const dayControls = document.getElementById('dayControls');
      
      if (view === 'day') {
        if (weekControls) weekControls.classList.add('hidden');
        if (dayControls) dayControls.classList.remove('hidden');
      } else {
        if (weekControls) weekControls.classList.remove('hidden');
        if (dayControls) dayControls.classList.add('hidden');
      }
      
      createCalendarGrid();
      populateCalendar();
      updateURL();
    }
    
    // Populate counsellor dropdown
    function populateCounsellorDropdown() {
      const select = document.getElementById('counsellorSelect');
      const counsellors = new Set();
      
      bookingData.forEach(booking => {
        if (booking.client && booking.client.trim()) {
          counsellors.add(booking.client.trim());
        }
      });
      
      select.innerHTML = '<option value="">Select Counsellor</option>';
      
      Array.from(counsellors).sort().forEach(counsellor => {
        const option = document.createElement('option');
        option.value = counsellor;
        option.textContent = counsellor;
        if (counsellor === selectedCounsellor) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }
    
    // UPDATED: Change week navigation
    function changeWeek(direction) {
        restoreSessionState(); 
      currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
      updateWeekDisplay();
      createCalendarGrid();
      populateCalendar();
      updateURL();
    }
    
    // Change day navigation
    function changeDay(direction) {
      restoreSessionState();
      const dateSelector = document.getElementById('dateSelector');
      if (!dateSelector) return;
      
      const currentDateObj = new Date(dateSelector.value + 'T12:00:00');
      currentDateObj.setDate(currentDateObj.getDate() + direction);
      
      // Format as YYYY-MM-DD
      const year = currentDateObj.getFullYear();
      const month = String(currentDateObj.getMonth() + 1).padStart(2, '0');
      const day = String(currentDateObj.getDate()).padStart(2, '0');
      const newDate = `${year}-${month}-${day}`;
      
      dateSelector.value = newDate;
      currentDate = newDate;
      
      createCalendarGrid();
      populateCalendar();
      updateURL();
    }
    
    // Jump to today
    function goToToday() {
      restoreSessionState();
      const dateSelector = document.getElementById('dateSelector');
      if (!dateSelector) return;
      
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const todayStr = `${year}-${month}-${day}`;
      
      dateSelector.value = todayStr;
      currentDate = todayStr;
      
      createCalendarGrid();
      populateCalendar();
      updateURL();
    }
    
    // Update week display text
    function updateWeekDisplay() {
      const weekEnd = new Date(currentWeekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      
      const startStr = currentWeekStart.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      const endStr = weekEnd.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      
      document.getElementById('weekDisplay').textContent = `${startStr} - ${endStr}`;
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 7.1: CALENDAR GRID CREATION -->
<!-- ================================ -->
  <script>
    // Create calendar grid based on current view
    function createCalendarGrid() {
      const grid = document.getElementById("calendarGrid");
      
      if (!grid) {
        console.error('Could not find calendarGrid element!');
        return;
      }
      
      grid.innerHTML = '';
      
      // Toggle CSS classes for view-specific styling
      grid.classList.remove('day-view', 'week-view');
      grid.classList.add(currentView === 'day' ? 'day-view' : 'week-view');
      
      if (currentView === 'day') {
        createDayGrid(grid);
      } else {
        createWeekGrid(grid);
      }
    }
    
    // Create day view grid - DYNAMIC FROM ROOM CONFIG
    function createDayGrid(grid) {
      const rooms = window.enabledRooms || [];
      console.log('üîç¬ç createDayGrid called - rooms:', rooms.length, rooms.map(r => r.displayName));
      
      // Set grid columns based on enabled rooms
      const numRooms = rooms.length;
      grid.style.gridTemplateColumns = `60px repeat(${numRooms}, 1fr)`;
      
      const emptyCell = document.createElement("div");
      emptyCell.className = "grid-header";
      emptyCell.textContent = "Time";
      grid.appendChild(emptyCell);
      
      rooms.forEach(room => {
        const header = document.createElement("div");
        header.className = "grid-header";
        header.textContent = room.displayName;
        grid.appendChild(header);
      });
      
      businessHours.forEach(time => {
        const timeCell = document.createElement("div");
        timeCell.className = "time-header";
        timeCell.textContent = time;
        grid.appendChild(timeCell);
        
        rooms.forEach((room) => {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          
          // Generate cell ID to match populateDayView format
          let roomId;
          if (room.key.startsWith('Room_')) {
            roomId = room.key.replace('Room_', ''); // "Room_6" -> "6"
          } else if (room.key === 'Car_Park') {
            roomId = 'car-park';
          } else if (room.key === 'Online') {
            roomId = 'online';
          } else {
            roomId = room.key.toLowerCase().replace('_', '-');
          }
          
          cell.id = `cell-${roomId}-${time}`;
          
          // Data attributes for future drag-and-drop support
          cell.dataset.room = room.key;
          cell.dataset.time = time;
          
          // Mark car park cells for special handling
          if (room.key === 'Car_Park') {
            cell.classList.add('car-park-cell');
            cell.dataset.capacity = room.capacity || 1;
          }
          
          grid.appendChild(cell);
        });
      });
    }
    
    // Create week view grid
    function createWeekGrid(grid) {
      // FIXED: Set grid columns for week view (1 time column + 7 day columns)
      grid.style.gridTemplateColumns = '80px repeat(7, 1fr)';
      
      const emptyCell = document.createElement("div");
      emptyCell.className = "grid-header";
      emptyCell.textContent = "Time";
      grid.appendChild(emptyCell);
      
      const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      
      for (let i = 0; i < 7; i++) {
        const cellDate = new Date(currentWeekStart);
        cellDate.setDate(currentWeekStart.getDate() + i);
        
        const header = document.createElement("div");
        header.className = "grid-header";
        const dayNum = String(cellDate.getDate()).padStart(2, '0');
        const monthNum = String(cellDate.getMonth() + 1).padStart(2, '0');
        header.textContent = `${weekDays[i]} ${dayNum}/${monthNum}`;
        grid.appendChild(header);
      }
      
      businessHours.forEach(time => {
        const timeCell = document.createElement("div");
        timeCell.className = "time-header";
        timeCell.textContent = time;
        grid.appendChild(timeCell);
        
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          cell.id = `week-cell-${day}-${time}`;
          grid.appendChild(cell);
        }
      });
      
      updateWeekDisplay();
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 7.2: CALENDAR POPULATION -->
<!-- ================================ -->
  <script>
    // UPDATED: Populate calendar with booking data
    function populateCalendar() {
        restoreSessionState(); 
      
      // Convert NodeList to Array to avoid mutation issues during iteration
      const cells = Array.from(document.querySelectorAll('.grid-cell'));
      
      cells.forEach(cell => {
        // Clone and replace to remove all event listeners, but keep the ID
        const cellId = cell.id;
        const newCell = cell.cloneNode(false);
        newCell.id = cellId;
        newCell.className = 'grid-cell';
        newCell.style.cursor = '';
        newCell.title = '';
        if (cell.parentNode) {
          cell.parentNode.replaceChild(newCell, cell);
        }
      });
      
      // Filter out holding room bookings from regular calendar display
      let filteredBookings = bookingData.filter(booking => 
        booking.room !== 'Henley_Holding_Room' && 
        booking.room !== '18' &&
        booking.date !== '2030-01-01'
      );
      
      // Use stored counsellor name for filtering
      const storedCounsellor = sessionStorage.getItem('counsellorName');
      if (currentView === 'week' && (selectedCounsellor || storedCounsellor)) {
        const counsellorToFilter = selectedCounsellor || storedCounsellor;
        filteredBookings = filteredBookings.filter(booking => 
          booking.client && booking.client.toLowerCase().includes(counsellorToFilter.toLowerCase())
        );
      }
      
      if (currentView === 'day') {
        populateDayView(filteredBookings);
      } else {
        populateWeekView(filteredBookings);
      }
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 7.3: DAY VIEW POPULATION -->
<!-- ================================ -->
  <script>
   // UPDATED: Populate day view - NOW WITH CLICK HANDLERS FOR OWN BOOKINGS
    function populateDayView(filteredBookings) {
      const selectedDate = document.getElementById('dateSelector').value;
      
      const dayBookings = filteredBookings.filter(booking => {
        return booking.date === selectedDate;
      });
      
      // Get logged-in counsellor name for ownership check
      const loggedInCounsellor = selectedCounsellor || sessionStorage.getItem('counsellorName') || '';
      const hasValidToken = !!sessionStorage.getItem('accessToken');
      
      dayBookings.forEach(booking => {
        const {roomNumber, roomClass} = getRoomMapping(booking);
        console.log('üîç¬ç Booking:', booking.client, 'room:', booking.room, '‚Üí roomNumber:', roomNumber, '‚Üí cellId:', `cell-${roomNumber}-${booking.start}`);
        if (!roomNumber) return;
        
        const startHour = parseInt(booking.start.split(':')[0]);
        const endHour = parseInt(booking.end.split(':')[0]);
        
        // Check if this is the logged-in user's booking
        const isOwnBooking = loggedInCounsellor && 
          booking.client && 
          booking.client.toLowerCase().includes(loggedInCounsellor.toLowerCase());
        
        const isWithin24Hours = isBookingWithin24Hours(booking.date, booking.start);
        
        for (let hour = startHour; hour < endHour; hour++) {
          if (hour >= 8 && hour <= 20) {
            const timeString = `${String(hour).padStart(2, '0')}:00`;
            const cellId = `cell-${roomNumber}-${timeString}`;
            const cell = document.getElementById(cellId);
            
            if (cell) {
              cell.classList.add('booked', roomClass);
              
              if (isWithin24Hours) {
                cell.classList.add('past-booking');
              }
              
              const bookingCode = booking.bookingId || booking.code || '';
              const paymentIndicator = booking.isPaid ? '' : ' (Old system)';
              const roomDisplayName = getRoomDisplayName(booking);
              
              cell.innerHTML = `
                <div class="booking-info">${booking.client || ''}</div>
                <div class="client-name">${bookingCode}${paymentIndicator}</div>
              `;
              
              // Only allow clicking own bookings when authenticated
              if (hasValidToken && isOwnBooking && !isWithin24Hours) {
                cell.style.cursor = 'pointer';
                cell.title = 'Click to modify this booking';
                
                cell.addEventListener('click', (function(bookingData, roomName, rNum) {
                  return function() {
                    const bookingCode = bookingData.bookingId || bookingData.code || '';
                    const date = bookingData.date;
                    const time = bookingData.start;
                    
                    prefillForm(bookingCode, roomName, date, time);
                    
                    document.querySelectorAll('.selected-booking').forEach(c => c.classList.remove('selected-booking'));
                    
                    const startH = parseInt(bookingData.start.split(':')[0]);
                    const endH = parseInt(bookingData.end.split(':')[0]);
                    for (let h = startH; h < endH; h++) {
                      const ts = `${String(h).padStart(2, '0')}:00`;
                      const cId = `cell-${rNum}-${ts}`;
                      const c = document.getElementById(cId);
                      if (c) c.classList.add('selected-booking');
                    }
                    
                    const formContainer = document.querySelector('.form-container');
                    if (formContainer) {
                      formContainer.scrollIntoView({ behavior: 'smooth' });
                    }
                  };
                })(booking, roomDisplayName, roomNumber));
              } else if (hasValidToken && isOwnBooking && isWithin24Hours) {
                cell.style.cursor = 'not-allowed';
                cell.title = 'Within 24 hours - cannot modify online';
              } else if (hasValidToken && !isOwnBooking) {
                cell.style.cursor = 'default';
                cell.title = `${booking.client}'s booking - view only`;
              } else {
                cell.style.cursor = 'default';
              }
            }
          }
        }
      });
      
      // Handle empty slots for new bookings
      console.log('Empty slot check:', { hasValidToken, hasPricingConfig: !!pricingConfig });
      if (hasValidToken && pricingConfig && typeof markAvailableSlotsForNewBookings === 'function') {
        markAvailableSlotsForNewBookings(selectedDate);
      } else if (hasValidToken && !pricingConfig) {
        console.warn('Pricing config not loaded - new booking feature disabled.');
      }
    }
  </script>
  
  <!-- ================================ -->
<!-- SECTION 7.4: WEEK VIEW POPULATION -->
<!-- ================================ -->
  <script>
    // FIXED: Populate week view - handles multiple bookings per cell (Room + Car Park etc)
    function populateWeekView(filteredBookings) {
      // Get counsellor from session or global
      if (!selectedCounsellor) {
        const stored = sessionStorage.getItem('counsellorName');
        if (stored) selectedCounsellor = stored;
      }
      
      // Debug logging
      console.log('üÜî populateWeekView called - counsellor:', selectedCounsellor, 'bookings:', filteredBookings.length);
      
      if (!selectedCounsellor) {
        console.warn('‚ö†Ô∏è No counsellor selected - week view requires a logged-in user');
        return;
      }
      
      // Filter to only this counsellor's bookings
      const counsellorBookings = filteredBookings.filter(booking => 
        booking.client && booking.client.toLowerCase().includes(selectedCounsellor.toLowerCase())
      );
      
      console.log('üÜî Filtered to', counsellorBookings.length, 'bookings for', selectedCounsellor);
      
      // Build a map of cellId -> array of bookings
      const cellBookings = {};
      
      counsellorBookings.forEach(booking => {
        const bookingDate = new Date(booking.date + 'T12:00:00');
        
        const weekStartNoon = new Date(currentWeekStart);
        weekStartNoon.setHours(12, 0, 0, 0);
        
        const msPerDay = 24 * 60 * 60 * 1000;
        const timeDiff = bookingDate.getTime() - weekStartNoon.getTime();
        const daysDiff = Math.round(timeDiff / msPerDay);
        
        if (daysDiff >= 0 && daysDiff <= 6) {
          const startHour = parseInt(booking.start.split(':')[0]);
          const endHour = parseInt(booking.end.split(':')[0]);
          
          for (let hour = startHour; hour < endHour; hour++) {
            if (hour >= 8 && hour <= 20) {
              const timeString = `${String(hour).padStart(2, '0')}:00`;
              const cellId = `week-cell-${daysDiff}-${timeString}`;
              
              if (!cellBookings[cellId]) {
                cellBookings[cellId] = [];
              }
              
              // Get room info
              const {roomClass} = getRoomMapping(booking);
              const roomDisplayName = getRoomDisplayName(booking);
              const isWithin24Hours = isBookingWithin24Hours(booking.date, booking.start);
              
              // Check if this exact booking is already added (avoid duplicates)
              const existingIdx = cellBookings[cellId].findIndex(b => 
                b.booking.bookingId === booking.bookingId && b.roomClass === roomClass
              );
              
              if (existingIdx === -1) {
                cellBookings[cellId].push({
                  booking: booking,
                  roomClass: roomClass,
                  roomDisplayName: roomDisplayName,
                  isWithin24Hours: isWithin24Hours
                });
              }
            }
          }
        }
      });
      
      console.log('üÜî Mapped bookings to', Object.keys(cellBookings).length, 'cells');
      
      // Now populate cells
      Object.entries(cellBookings).forEach(([cellId, bookings]) => {
        const cell = document.getElementById(cellId);
        if (!cell) {
          console.warn('‚ö†Ô∏è Cell not found:', cellId);
          return;
        }
        
        cell.classList.add('booked');
        
        // Check for booking to modify highlight
        const hasHighlight = bookings.some(b => 
          window.bookingToModify && 
          (b.booking.bookingId === window.bookingToModify.bookingId || 
           b.booking.code === window.bookingToModify.bookingId) &&
          b.booking.date === window.bookingToModify.date &&
          b.booking.start === window.bookingToModify.time
        );
        
        if (hasHighlight) {
          cell.classList.add('selected-booking');
        }
        
        if (bookings.length > 1) {
          // Multiple bookings - show side by side
          cell.classList.add('multi-booking');
          
          cell.innerHTML = bookings.map((b, idx) => {
            const bookingCode = b.booking.bookingId || b.booking.code || '';
            const paymentIndicator = b.booking.isPaid ? '' : ' (Old)';
            const pastClass = b.isWithin24Hours ? ' past-booking' : '';
            
            return `<div class="booking-segment ${b.roomClass}${pastClass}" data-booking-idx="${idx}">
                      <div class="booking-info">${b.roomDisplayName}</div>
                      <div class="client-name">${bookingCode}${paymentIndicator}</div>
                    </div>`;
          }).join('');
          
          // Add click handlers to each segment
          cell.querySelectorAll('.booking-segment').forEach((segment, idx) => {
            const b = bookings[idx];
            if (!b.isWithin24Hours && sessionStorage.getItem('accessToken')) {
              segment.style.cursor = 'pointer';
              segment.onclick = (e) => {
                e.stopPropagation();
                prefillForm(b.booking.bookingId, b.roomDisplayName, b.booking.date, b.booking.start);
                
                document.querySelectorAll('.selected-booking').forEach(c => c.classList.remove('selected-booking'));
                cell.classList.add('selected-booking');
                
                const formContainer = document.querySelector('.form-container');
                if (formContainer) {
                  formContainer.scrollIntoView({ behavior: 'smooth' });
                }
              };
            }
          });
          
        } else {
          // Single booking
          const b = bookings[0];
          const bookingCode = b.booking.bookingId || b.booking.code || '';
          const paymentIndicator = b.booking.isPaid ? '' : ' (Old system)';
          
          cell.classList.add(b.roomClass);
          
          if (b.isWithin24Hours) {
            cell.classList.add('past-booking');
          }
          
          cell.innerHTML = `
            <div class="booking-info">${b.roomDisplayName}</div>
            <div class="client-name">${bookingCode}${paymentIndicator}</div>
          `;
          
          // Only allow clicking if we have a valid token and not within 24 hours
          if (!b.isWithin24Hours && sessionStorage.getItem('accessToken')) {
            cell.addEventListener('click', function() {
              prefillForm(bookingCode, b.roomDisplayName, b.booking.date, b.booking.start);
              
              document.querySelectorAll('.selected-booking').forEach(c => c.classList.remove('selected-booking'));
              cell.classList.add('selected-booking');
              
              const formContainer = document.querySelector('.form-container');
              if (formContainer) {
                formContainer.scrollIntoView({ behavior: 'smooth' });
              }
            });
          }
        }
      });
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 8: DATA LOADING FUNCTIONS -->
<!-- ================================ -->
  <script>
    // Load booking data with priority for specific counsellor
    async function loadBookingDataWithPriority(priorityCounsellor = null) {
      const statusElement = document.getElementById('dataStatus');
      const startTime = Date.now();
      
      try {
        if (statusElement) statusElement.textContent = 'Loading booking data...';
        
        // Get data from Firebase
        const snapshot = await database.ref('bookings').once('value');
        const jsonData = snapshot.val() || [];
        
        // Convert to array if needed
        const bookingArray = Array.isArray(jsonData) ? jsonData : Object.values(jsonData);
        
// Filter out cancelled bookings first
const cancelledCount = bookingArray.filter(b => b.status === 'cancelled' || b.status === 'cancel').length;
const activeBookings = bookingArray.filter(booking => 
  booking.status !== 'cancelled' && booking.status !== 'cancel'
);
        
        if (cancelledCount > 0) {
          console.log(`Filtered out ${cancelledCount} cancelled bookings`);
        }
        
        // Filter out holding room bookings (legacy cleanup)
        bookingData = activeBookings.filter(booking => 
          booking.room !== 'Henley_Holding_Room' && 
          booking.room !== '18' &&
          booking.date !== '2030-01-01'
        );
        
        console.log(`Firebase: Loaded ${bookingData.length} bookings in ${Date.now() - startTime}ms`);
        
if (statusElement) {
          let statusText = `Loaded ${bookingData.length} bookings`;
          if (priorityCounsellor) {
            const priorityCount = bookingData.filter(b => b.client === priorityCounsellor).length;
            statusText += ` - ${priorityCount} for ${priorityCounsellor}`;
          }
          statusElement.textContent = statusText;
          statusElement.style.color = '#28a745';
          
          setTimeout(() => {
            statusElement.textContent = '';
          }, 3000);
        }
        
        // Set up real-time listener for updates
        database.ref('bookings').on('value', (snapshot) => {
          const updatedData = snapshot.val() || [];
          const updatedArray = Array.isArray(updatedData) ? updatedData : Object.values(updatedData);
          
// Filter out cancelled bookings first
const activeUpdatedBookings = updatedArray.filter(booking => 
  booking.status !== 'cancelled' && booking.status !== 'cancel'
);
          
          // Update local data (excluding cancelled and legacy holding room)
          bookingData = activeUpdatedBookings.filter(booking => 
            booking.room !== 'Henley_Holding_Room' && 
            booking.room !== '18' &&
            booking.date !== '2030-01-01'
          );
          populateCalendar();
          console.log('Data updated in real-time!');
        });
        
        return Promise.resolve();
        
      } catch (error) {
        console.error('Firebase error:', error);
        bookingData = [];
        holdingRoomBookings = [];
        updateHoldingRoomCount();
        return Promise.resolve();
      }
    }
    
    // Load booking data
    async function loadBookingData() {
      const priorityCounsellor = selectedCounsellor || sessionStorage.getItem('counsellorName') || null;
      return loadBookingDataWithPriority(priorityCounsellor);
    }
    
    // Refresh data manually
    function refreshData() {
      console.log('Manual refresh triggered');
      try {
        sessionStorage.removeItem('bookingDataCache');
      } catch (e) {
        console.warn('Could not clear cache:', e);
      }
      
      const priorityCounsellor = selectedCounsellor || sessionStorage.getItem('counsellorName') || null;
      loadBookingDataWithPriority(priorityCounsellor).then(() => {
        console.log('Refresh complete, repopulating calendar');
        populateCalendar();
      });
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 8.1: URL & STATE MANAGEMENT -->
<!-- ================================ -->
  <script>
    // FIXED: Update URL with token preservation
    function updateURL() {
      // start from current query so we don't drop unknown params
      const current = new URLSearchParams(window.location.search);
      const existingToken = current.get('token');
      const sessionToken = sessionStorage.getItem('accessToken');
      const params = new URLSearchParams();
      
      const token = sessionToken || existingToken;
      if (token) params.set('token', token);
      
      params.set('view', currentView);
      
      if (window.clientId && (selectedCounsellor || sessionStorage.getItem('counsellorName'))) {
        params.set('clientId', window.clientId);
        params.set('name', encodeURIComponent(selectedCounsellor || sessionStorage.getItem('counsellorName') || ''));
      } else if (selectedCounsellor) {
        params.set('counsellor', encodeURIComponent(selectedCounsellor));
      }
      
      if (currentView === 'day') {
        const ds = document.getElementById('dateSelector');
        params.set('date', ds ? ds.value : currentDate);
      } else {
        params.set('date', formatDate(currentWeekStart));
      }
      
      const newURL = window.location.pathname + '?' + params.toString();
      window.history.replaceState({}, '', newURL);
    }
    
    // Initialize view buttons
    function updateViewButtons() {
      const dayBtn = document.querySelector('[onclick="switchView(\'day\')"]');
      const weekBtn = document.querySelector('[onclick="switchView(\'week\')"]');
      
      if (dayBtn && weekBtn) {
        dayBtn.classList.toggle('active', currentView === 'day');
        weekBtn.classList.toggle('active', currentView === 'week');
      }
    }
    
    // Update controls visibility based on view
    function updateControlsVisibility() {
      const dayControls = document.getElementById('dayControls');
      const weekControls = document.getElementById('weekControls');
      const counsellorContainer = document.getElementById('counsellorFilterContainer');
      
      if (dayControls) dayControls.classList.toggle('hidden', currentView !== 'day');
      if (weekControls) weekControls.classList.toggle('hidden', currentView !== 'week');
      
      // Hide counsellor selector if we have a token
      if (counsellorContainer && !sessionStorage.getItem('accessToken')) {
        counsellorContainer.classList.toggle('hidden', false);
      } else if (counsellorContainer) {
        counsellorContainer.style.display = 'none';
      }
    }
  </script>
  
<!-- ================================ -->
<!-- SECTION 8.2: DATA INITIALIZATION -->
<!-- ================================ -->
  <script>
function initializeData() {
  const priorityCounsellor = selectedCounsellor || sessionStorage.getItem('counsellorName') || null;
  
  // Load room config first, then pricing, then bookings, then credits
  if (typeof loadRoomConfig === 'function') {
    loadRoomConfig()
      .then(() => loadPricingConfig())
      .then(() => loadBookingDataWithPriority(priorityCounsellor))
      .then(() => populateCalendar())
      .then(() => {
        // Load credits and update title after everything else
        if (typeof loadCreditBalance === 'function') loadCreditBalance();
        if (typeof updatePageTitleWithCounsellor === 'function') updatePageTitleWithCounsellor();
        if (typeof setupCreditBalanceListener === 'function') setupCreditBalanceListener();
      });
  } else {
    // Fallback if room-config.js not loaded
    loadPricingConfig()
      .then(() => loadBookingDataWithPriority(priorityCounsellor))
      .then(() => populateCalendar())
      .then(() => {
        if (typeof loadCreditBalance === 'function') loadCreditBalance();
        if (typeof updatePageTitleWithCounsellor === 'function') updatePageTitleWithCounsellor();
        if (typeof setupCreditBalanceListener === 'function') setupCreditBalanceListener();
      });
  }
} 
    
    // Initialize when DOM is ready - CORRECTED VERSION
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, starting initialization...');
      handlePaymentReturn();
      // Call parseURLParams which will handle the rest of initialization
      parseURLParams(); // This handles everything now
    });
  </script>
  
<!-- ================================ -->
<!-- SECTION 9: EXTERNAL JS FILES -->
<!-- ================================ -->
  <!-- Token auth override - must load first -->
  <script src="js/room-config.js"></script>
  
  <!-- PATCH: Fix Car Park case sensitivity (room-config.js has missing return statement) -->
  <script>
  (function() {
    // Wrap the getRoomKey function to handle 'Car park' (lowercase p)
    // and fix missing return statement in room-config.js
    const originalGetRoomKey = window.getRoomKey;
    if (typeof originalGetRoomKey === 'function') {
      window.getRoomKey = function(booking) {
        if (!booking) return null;
        
        // Check for Car park with any case variation (fixes missing return in room-config.js)
        const room = booking.room;
        if (room && (room.toLowerCase() === 'car park' || room.toLowerCase() === 'car_park')) {
          return 'Car_Park';
        }
        
        // Call original function for other cases
        return originalGetRoomKey(booking);
      };
      console.log('‚úÖ Car Park case-sensitivity patch applied');
    }
  })();
  </script>
  
  <script src="js/token-auth-update.js"></script>
  <!-- Account & payment system -->
  <script src="js/account.js"></script>
  <!-- Booking enhancements (¬£0 bookings, basket, etc) -->
  <script src="js/booking-enhancements.js"></script>
</body>
</html>
